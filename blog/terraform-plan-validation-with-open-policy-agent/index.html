<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Terraform Plan Validation With Open Policy Agent | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Automating Terraform plan analysis with Open Policy Agent"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.198233a1441f0270f2f94fc2b57dbe608eca4df486e2fc6d3a7bd0e1c8d48223.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><article><header><h1>Terraform Plan Validation With Open Policy Agent</h1><time>May 9, 2021</time></header><div><p><em>A pattern for automating Terraform plan analysis using Open Policy Agent.</em></p><h2 id=problem>Problem</h2><p>Your project&rsquo;s CI/CD pipeline performs a Terraform <a href=https://www.terraform.io/docs/cli/commands/plan.html>plan</a> prior to executing a Terraform <a href=https://www.terraform.io/docs/cli/commands/apply.html>apply</a>. The CI/CD pipeline gates on the Terraform plan, such that team members can manually review its output for unwanted, problematic, and/or destructive resource modifications. While the manual plan review helps protect against the application of changes that could negatively impact systems&rsquo; availability, the analysis is tedious and error prone.</p><p>Could aspects of the Terraform plan analysis be automated? Could such automation help expedite reviews and further protect against errors? <a href=https://www.hashicorp.com/sentinel>HashiCorp Sentinel</a> offers a commercial policy-as-code solution, but what free and open source Terraform policy-as-code tooling exists?</p><h2 id=solution>Solution</h2><p><a href=https://www.openpolicyagent.org/>Open Policy Agent</a> offers a flexible, multi-purpose policy-as-code framework. Its <a href=https://www.openpolicyagent.org/docs/latest/terraform/>Terraform support</a> enables the codification of rules and expectations pertaining to Terraform configuration, in effect providing a toolset through which Terraform plan analysis and safeguards can be automated in CI/CD pipelines and development processes.</p><h2 id=example>Example</h2><p>For the purposes of simplicity, consider a simple &ndash; though somewhat contrived &ndash; example. An apply of the following Terraform configuration creates a <code>greet.sh</code> script that <code>echo</code>s the <code>var.greeting</code>&rsquo;s value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#66d9ef>greeting</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The greeting to echo from the greet.sh script&#34;</span>
</span></span><span style=display:flex><span>  value       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;template_file&#34; &#34;greeting&#34;</span> {
</span></span><span style=display:flex><span>  template <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&lt;&lt;-</span><span style=color:#66d9ef>EOT</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  #!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;${var.greeting}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>EOT</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;local_file&#34; &#34;greeting&#34;</span> {
</span></span><span style=display:flex><span>  content  <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>template_file</span>.<span style=color:#66d9ef>greeting</span>.<span style=color:#66d9ef>rendered</span>
</span></span><span style=display:flex><span>  filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/greeting.sh&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By default, this configuration creates a <code>greet.sh</code> file using the default <code>var.greeting</code> value of <code>"hello"</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span></code></pre></div><p>When the default <code>var.greeting</code> value is used, a <code>terraform plan</code> of the configuration reveals the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>terraform</span> <span style=color:#a6e22e>plan</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>used</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>selected</span> <span style=color:#a6e22e>providers</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>generate</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>plan</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Resource</span> <span style=color:#a6e22e>actions</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>indicated</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>symbols</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>+</span> <span style=color:#a6e22e>create</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>perform</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>actions</span><span style=color:#f92672>:</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # local_file.greeting will be created
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>+</span> <span style=color:#a6e22e>resource</span> <span style=color:#e6db74>&#34;local_file&#34;</span> <span style=color:#e6db74>&#34;greeting&#34;</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#a6e22e>content</span>              = <span style=color:#f92672>&lt;&lt;-EOT</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            #/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            echo &#34;hello&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#f92672>EOT</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#a6e22e>directory_permission</span> = <span style=color:#e6db74>&#34;0777&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#a6e22e>file_permission</span>      = <span style=color:#e6db74>&#34;0777&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#a6e22e>filename</span>             = <span style=color:#e6db74>&#34;./greeting.sh&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>                   = (<span style=color:#a6e22e>known</span> <span style=color:#a6e22e>after</span> <span style=color:#a6e22e>apply</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Plan</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>add</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>change</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>destroy</span>.
</span></span></code></pre></div><p>How can <a href=https://openpolicyagent.org>OPA</a> be used to codify a policy guarding against unwanted configuration? For example, how could OPA be used to ensure that <code>var.greeting</code> never has an inappropriate greeting value, such as <code>"goodbye"</code>? How could OPA&rsquo;s <a href=https://www.openpolicyagent.org/docs/latest/policy-language/>Rego</a> policy language express such a policy?</p><p>Admittedly, this is a contrived and perhaps unrealistic example. After all,
Terraform <a href=https://developer.hashicorp.com/terraform/language/expressions/custom-conditions>custom conditions</a> could enable enforcement in native Terraform:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#66d9ef>greeting</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The greeting to echo from the greet.sh script&#34;</span>
</span></span><span style=display:flex><span>  value       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>validation</span> {
</span></span><span style=display:flex><span>    condition     <span style=color:#f92672>=</span> var.greeting !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;goodbye&#34;</span>
</span></span><span style=display:flex><span>    error_message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The greeting value must be an appropriate greeting&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nonetheless, the following <code>policy.rego</code> file offers an OPA example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>package terraform.analysis
</span></span><span style=display:flex><span>import input as tfplan
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>has_acceptable_greeting {
</span></span><span style=display:flex><span>  greeting := input.variables[&#34;greeting&#34;]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  contains(greeting.value, &#34;goodbye&#34;) != true
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>policy.rego</code> policy accepts <a href=https://www.terraform.io/docs/internals/json-format.html>Terraform plan JSON</a> as input, analyzes the value of the plan JSON&rsquo;s <code>var.greeting</code>, and contains a <code>has_acceptable_greeting</code> expression checking that the plan JSON&rsquo;s <code>var.greeting</code> value does not contain <code>"goodbye"</code>.</p><p>The policy expressed in the <code>policy.rego</code> file can be evaluated via the <code>opa</code> CLI (See the <a href=https://www.openpolicyagent.org/docs/latest/#running-opa>OPA website&rsquo;s installation instructions</a>)&mldr;</p><p>First, execute a <code>terraform plan</code> and save the output to a <code>tf-plan.binary</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>terraform plan \
</span></span><span style=display:flex><span>  --out tf-plan.binary
</span></span></code></pre></div><p>Next, use <code>terraform show</code> to convert the <code>tf-plan.binary</code> to a <code>tf-plan.json</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>terraform show \
</span></span><span style=display:flex><span>  -json tf-plan.binary &gt; tf-plan.json
</span></span></code></pre></div><p>Finally, execute <code>opa eval</code> against the <code>has_acceptable_greeting</code> expression, specifying the <code>policy.rego</code> and <code>tf-plan.json</code> as the <code>--data</code> and <code>--input</code>, respectively, and also passing a <code>--fail</code> flag forcing a nonzero exit status if <code>has_acceptable_greeting</code> identifies a policy violation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>opa eval \
</span></span><span style=display:flex><span>  --data policy.rego \
</span></span><span style=display:flex><span>  --input tf-plan.json \
</span></span><span style=display:flex><span>  &#34;data.terraform.analysis.has_acceptable_greeting&#34; \
</span></span><span style=display:flex><span>  --fail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;result&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;expressions&#34;: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          &#34;value&#34;: true,
</span></span><span style=display:flex><span>          &#34;text&#34;: &#34;data.terraform.analysis.has_acceptable_greeting&#34;,
</span></span><span style=display:flex><span>          &#34;location&#34;: {
</span></span><span style=display:flex><span>            &#34;row&#34;: 1,
</span></span><span style=display:flex><span>            &#34;col&#34;: 1
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note <code>opa eval</code>&rsquo;s successful exit code; this indicates the plan JSON conforms to the codified <code>policy.rego</code> policy.</p><p>To check that <code>policy.rego</code>&rsquo;s <code>has_acceptable_greeting</code> correctly identifies unacceptable <code>var.greeting</code> values, pass a <code>-var greeting=goodbye</code> during <code>terraform plan</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>terraform plan \
</span></span><span style=display:flex><span>  -var &#39;greeting=goodbye&#39; \
</span></span><span style=display:flex><span>  --out tf-plan.binary
</span></span></code></pre></div><p>Convert the new <code>tf-plan.binary</code> to a <code>tf-plan.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>terraform show \
</span></span><span style=display:flex><span>  -json tf-plan.binary &gt; tf-plan.json
</span></span></code></pre></div><p>Execute <code>opa eval</code> against the new <code>tf-plan.json</code>; note its nonzero exit code indicating the plan JSON violates the codified <code>policy.rego</code> policy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>opa eval \
</span></span><span style=display:flex><span>  --data policy.rego \
</span></span><span style=display:flex><span>  --input tf-plan.json \
</span></span><span style=display:flex><span>  &#34;data.terraform.analysis.has_acceptable_greeting&#34; \
</span></span><span style=display:flex><span>  --fail
</span></span><span style=display:flex><span>{}
</span></span></code></pre></div><h2 id=more-advanced-use-cases>More advanced use cases</h2><p>While the <code>has_acceptable_greeting</code> example is quite simple and fairly contrived, more sophisticated real world policies might&mldr;</p><ul><li>ensure AWS security groups never allow ingress on port 22</li><li>protect against destructive actions on critical resources</li><li>verify the intended DNS record modifications during a Terraform-orchestrated DNS-based <a href=https://martinfowler.com/bliki/BlueGreenDeployment.html>blue/green deployment</a></li><li>ensure an ECR repository marked for destruction does not home OCI images used
by active ECR task definitions</li></ul><h2 id=policy-tests>Policy tests</h2><p>In addition to offering a policy-as-code framework, OPA can also verify the correctness of your policies via tests of the policies themselves.</p><p>For example, test cases exercising the <code>policy.rego</code>&rsquo;s <code>has_acceptable_greeting</code> policy can live in a <code>policy_test.rego</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>package terraform.analysis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_acceptable_greeting {
</span></span><span style=display:flex><span>  has_acceptable_greeting with input as {&#34;variables&#34;: {&#34;greeting&#34;: {&#34;value&#34;: &#34;hello&#34;}}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_acceptable_nondefault_greeting {
</span></span><span style=display:flex><span>  has_acceptable_greeting with input as {&#34;variables&#34;: {&#34;greeting&#34;: {&#34;value&#34;: &#34;hi&#34;}}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_inacceptable_greeting {
</span></span><span style=display:flex><span>  not has_acceptable_greeting with input as {&#34;variables&#34;: {&#34;greeting&#34;: {&#34;value&#34;: &#34;goodbye&#34;}}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_inacceptable_verbose_greeting {
</span></span><span style=display:flex><span>  not has_acceptable_greeting with input as {&#34;variables&#34;: {&#34;greeting&#34;: {&#34;value&#34;: &#34;foo goodbye bar&#34;}}}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>These test cases make assertions on <code>has_acceptable_greeting</code>&rsquo;s behavior given various Terraform plan JSON scenarios.</p><p>To execute the tests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>opa test . --verbose
</span></span><span style=display:flex><span>data.terraform.analysis.test_acceptable_greeting: PASS (328.455µs)
</span></span><span style=display:flex><span>data.terraform.analysis.test_acceptable_nondefault_greeting: PASS (122.705µs)
</span></span><span style=display:flex><span>data.terraform.analysis.test_inacceptable_greeting: PASS (125.167µs)
</span></span><span style=display:flex><span>data.terraform.analysis.test_inacceptable_verbose_greeting: PASS (83.331µs)
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>PASS: 4/4
</span></span></code></pre></div><h2 id=bonus-github-actions>Bonus: GitHub Actions</h2><p><a href=https://github.com/mdb/terraform-opa-demo>github.com/mdb/terraform-opa-demo</a> demonstrates a complete working example of the above-described techniques with the relevant sequence of commands codified as <code>Makefile</code> targets. View its <a href=https://github.com/mdb/terraform-opa-demo/actions>Actions</a> to see how OPA might work in a <a href=https://github.com/features/actions>GitHub Actions</a> CI/CD pipeline, as established by its <a href=https://github.com/mdb/terraform-opa-demo/blob/main/.github/workflows/main.yml>.github/workflows/main.yml</a> GitHub Actions configuration.</p></div><ul class=tags><li><a href=/tags/opa>opa</a></li><li><a href=/tags/terraform>terraform</a></li><li><a href=/tags/open-policy-agent>open policy agent</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built backend services, automated cloud infrastructure management, designed CI/CD pipelines for high scale distributed systems, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.e9d9f3cbf36a9c71782d61866b53384d62c0dd7b876b37b37cd921dfc29b78aa.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
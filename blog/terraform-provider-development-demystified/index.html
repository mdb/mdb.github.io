<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Terraform Provider Development Demystified | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/main.min.fc82b5f1b515fbd2833bd59ff79fa346acc53053fa47e21268ea8a00c448d9c9.css></head><body class=DEV><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>July 14, 2022</time><article><header><h1>Terraform Provider Development Demystified</h1></header><div><p><em>Many Terraform practitioners may be naive to provider development. How are providers implemented?</em></p><h2 id=review-of-the-basics>Review of the basics</h2><h3 id=terraform>Terraform</h3><p>At its core, Terraform enables users to describe infrastructure resources &ndash; and their dependency relationships &ndash; in <code>.tf</code> files using <a href=https://github.com/hashicorp/hcl>HCL</a>.</p><p>These HCL-declared infrastructure resources are often associated with cloud infrastructure services, such as AWS, OpenStack, or Kubernetes, but they might also be local files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;digitalocean_droplet&#34; &#34;web&#34;</span> {
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tf-web&#34;</span>
</span></span><span style=display:flex><span>  size   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;512mb&#34;</span>
</span></span><span style=display:flex><span>  image  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;centos-5-8-x32&#34;</span>
</span></span><span style=display:flex><span>  region <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sfo1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;dnsimple_record&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  domain <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example.com&#34;</span>
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span>  value  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${digitalocean_droplet.web.ipv4_address}&#34;</span>
</span></span><span style=display:flex><span>  type   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When invoked against a configuration (i.e. a collection of resources specified in <code>*.tf</code> files) via the <code>terraform plan</code> or <code>terraform apply</code> CLI commands, Terraform builds a dependency graph of resource relationships and attributes and analyzes&mldr;</p><ol><li>what has been specified in the <code>*.tf</code> files?</li><li>how does that compare to what has been captured in <a href=https://www.terraform.io/language/state>Terraform state</a>?</li><li>how does all that compare to what may or may not actually exist, as reported by the resources&rsquo; corresponding APIs?</li></ol><p>Based on its analysis, Terraform decides the order in which it must invoke the necessary CRUD (&ldquo;create,&rdquo; &ldquo;read,&rdquo; &ldquo;update,&rdquo; or &ldquo;destroy&rdquo;) actions against the resources&rsquo; APIs in order to produce the desired state, as specified in <code>*.tf</code> configuration.</p><h3 id=terraform-providers>Terraform providers</h3><p>Resources are associated with <em>providers</em>. When declaring a resource in a <code>.tf</code> HCL file, the provider name appears as the <code>${provider name}_</code> prefix. In the following example, Grafana is the provider associated with a folder resource:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;grafana_folder&#34; &#34;foo&#34;</span> {
</span></span><span style=display:flex><span>  uid   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>  title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Terraform Folder With UID foo&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As mentioned, providers are often cloud infrastructure services such as AWS, OpenStack, Fastly, etc., but might also be&mldr;</p><ul><li>SaaS platforms such as Grafana, GitHub, OKTA, etc.</li><li>a local file system, etc.</li></ul><p>Generally speaking, a provider could be anything that can be modeled declaritively and has some sort of corresponding CRUD API (or collection of CRUD APIs).</p><p>Providers are decoupled from the Terraform CLI itself as independent software components, often versioned, compiled, and published to the <a href=https://registry.terraform.io/browse/providers>Terraform registry</a> via their own CI/CD processes.</p><p>Providers are generally authored in Go using Terraform&rsquo;s <a href=github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>. How does this work?</p><h2 id=specifying-a-provider>Specifying a provider</h2><p>Assuming the use of the <a href=https://github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>, a provider is specified via a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Provider>*schema.Provider</a> on which a few key fields are specified, most notably fields like&mldr;</p><ul><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported provider arguments and attributes</li><li><code>ResourcesMap</code> - a <code>map[string]*schema.Resource</code> specifying the supported resources and their related functions</li><li><code>DataSourcesMap</code> - a <code>map[string]*schema.Resource</code> specifying the supported data sources and their related functions</li></ul><p>To learn more:</p><ul><li><a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Provider><code>schema.Provider</code> Godocs</a></li><li><a href=https://github.com/grafana/terraform-provider-grafana/blob/master/grafana/provider.go><code>terraform-provider-grafana</code> example</a></li></ul><h2 id=resources>Resources</h2><p>Individual provider resources are managed via functions that return a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource>*schema.Resource</a> on which a few key fields are specified, most notably fields like&mldr;</p><ul><li><code>Description</code> - a description of the resource used to generate documentation</li><li><code>Create</code> - a function for creating the resource from configuration via the provider API</li><li><code>Read</code> - a function for reading the resource from configuration via the provider API</li><li><code>Update</code> - a function for updating the resource from configuration via the provider API</li><li><code>Delete</code> - a function for deleting the resource if/when it&rsquo;s removed from configuration via the provider API</li><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported resource arguments and attributes</li><li>etc.</li></ul><p>Generally, the individual CRUD functions accept a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#ResourceData>schema.ResourceData</a> argument whose value from comes from Terraform configuration. The functions&rsquo; implementation interacts with the appropriate corresponding provider APIs to create, read, update, or delete the corresponding resource, accordingly.</p><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/558>an example PR implementing a <code>grafana_annotation</code> resource</a></li><li><a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource><code>schema.Resource</code> Godocs</a></li><li><a href=https://learn.hashicorp.com/collections/terraform/providers>Terraform provider development tutorial</a></li></ul><h2 id=data-sources>Data sources</h2><p>Terraform <a href=https://www.terraform.io/language/data-sources>data sources</a> enable Terraform to <em>read</em> outside information. Unlike resources &ndash; which enable Terraform to create, update, and delete resources &ndash; data sources are read-only.</p><p>Assuming the use of the <a href=github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>, individual provider data sources are managed via functions that return a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource>schema.Resource</a>, similar to that returned by resource functions. However, a data source&rsquo;s <code>*schema.Resource</code> typically only specifies:</p><ul><li><code>Description</code> - a description of the data source used to generate documentation</li><li><code>ReadContext</code> - a function for reading the resource specified in configuration via the associated provider API</li><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported resource arguments and attributes</li></ul><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/551>an example PR extending the <code>grafana_organization</code> data source</a></li></ul><h2 id=tying-it-together>Tying it together</h2><p>Finally, <code>main.go</code> provides the entry point for the provider program.</p><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/blob/master/main.go><code>terraform-provider-grafana</code> example</a></li></ul><h2 id=gnumakefile>GNUMakefile</h2><p>Most provider codebases feature a <code>GNUMakefile</code> in which various build and test commands are specified.</p><h2 id=testing>Testing</h2><p>While individual functions can be unit tested in isolation, the plugin SDK provides an <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk@v1.17.2/helper/acctest>acctest</a> and types (most notably <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk@v1.17.2/helper/resource#TestCase><code>resource.TestCase</code></a>) used to author acceptance tests against provider, provider resource, and provider data source functionality.</p><p>Generally, these acceptance tests are configured to target real APIs provided by cloud providers, though some Terraform providers &ndash; particularly those that target open source provider platforms or SaaS APIs &ndash; may configure acceptance tests to interact with <code>localhost</code>-hosted APIs enabled via tools such as <a href=https://www.docker.com/>Docker</a>. For example, <code>terraform-provider-grafana</code>&rsquo;s own acceptance testing utilizes a local Grafana established via <a href=https://github.com/grafana/terraform-provider-grafana/blob/v1.24.0/docker-compose.yml>docker-compose</a> in local development, as well as remote instances of Grafana in CI/CD.</p><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/558>an example PR adding tests of a new <code>grafana_annotation</code> resource</a></li><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/551>an example PR adding tests of new <code>grafana_organization</code> data source functionality</a></li><li><a href=https://drone.grafana.net/grafana/terraform-provider-grafana/1345>an example terraform-provider-grafana PR CI/CD execution</a></li></ul><h2 id=building>Building</h2><p>Typically, <a href=https://goreleaser.com/>goreleaser</a> is used to compile cross-platform provider binaries and publish them as versioned GitHub releases. <a href=https://github.com/grafana/terraform-provider-grafana/blob/v1.24.0/.goreleaser.yml>terraform-provider-grafana&rsquo;s <code>.goreleaser.yml</code></a> offers a configuration example used to publish its <a href=https://github.com/grafana/terraform-provider-grafana/releases>GitHub releases</a>.</p><p>Often, <a href=https://github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs>tfplugindocs</a> is integrated with providers&rsquo; build process to automate the generation of markdown documents documenting the provider; these are typically committed to a <a href=https://github.com/grafana/terraform-provider-grafana/tree/v1.24.0/docs>docs</a> directory in source control.</p><h2 id=releasing>Releasing</h2><p>Assuming the provider and its associated GitHub releases conform to some <a href=https://www.terraform.io/registry/providers/publishing>common standards</a>, the provider can be published to the <a href=https://www.terraform.io/registry/providers/publishing#publishing-to-the-registry>Terraform registry</a> where it can be downloaded by Terraform configurations that reference it and used by other Terraform practitioners.</p></div><ul class=tags><li><a href=/tags/infrastructure>infrastructure</a></li><li><a href=/tags/golang>golang</a></li><li><a href=/tags/cloud>cloud</a></li><li><a href=/tags/terraform>terraform</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end UIs, server backends, automated cloud infrastructure provisioning, built continuous deployment pipelines for highly available applications, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.aa52641949303234a18064e85add732c21e00fad81f7e38abc272a1d7dfe44c8.js></script></body></html>
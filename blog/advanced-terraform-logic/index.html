<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Advanced Terraform Logic | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.1793cf78540015f52d445efeea219c2a3ab4bc17725ba6b8caf459edd42ba3ae.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>November 8, 2022</time><article><header><h1>Advanced Terraform Logic</h1></header><div><p><em>Critics argue <a href=https://terraform.io>Terraform</a> is limiting and doesn&rsquo;t adequately enable the expression of complex logic. While imperfect, Terraform does indeed often accommodate moderately complex logic. As a reference example, the following illustrates how Terraform constructs such as <code>for_each</code>, <code>for</code>/<code>in</code>, <code>if</code>, <code>try</code>, various <a href=https://developer.hashicorp.com/terraform/language/functions>functions</a>, and custom <code>local</code> data structures can be used to successfully satisfy a relatively logic-intensive use case.</em></p><p><em>As a bonus, the reference example also teases some broader techniques for automating platform engineering across an organization.</em></p><p><a href=https://github.com/mdb/terraform-advanced-logic-demo>github.com/mdb/terraform-advanced-logic-demo</a> homes the source code referenced throughout this post.</p><h2 id=problem>Problem</h2><p>For example&rsquo;s sake, imagine a contrived scenario:</p><p>You&rsquo;d like to use Terraform to automate the management of <a href=https://grafana.com/>Grafana</a> folders and dashboards for each of a GitHub organization&rsquo;s microservices.</p><p>A few assumptions driving the implementation:</p><ol><li>the GitHub organization consists of multiple git repositories</li><li>each git repository may home zero or many microservices in its default branch</li><li>each microservice has a corresponding <code>Dockerfile</code></li><li>the <code>Dockerfile</code>&rsquo;s directory name indicates its microservice name</li><li>each git repository should have a corresponding Grafana folder following the naming convention of <code>${github_org}_${git_repository}</code></li><li>each microservice should have a corresponding Grafana dashboard following the naming convention of <code>${github_org}_${git_repository}_${microservice_name}</code>; the dashboard should live in the corresponding <code>${github_org}_${git_repository}</code> Grafana folder</li><li>if a microservice&rsquo;s <code>Dockerfile</code> is homed in a git repository&rsquo;s root (and not a subdirectory), the Grafana dashboard should be named <code>${github_org}_${git_repository}</code></li><li>git repositories may feature a dot (<code>.</code>) in their name, though Grafana folders and dashboards should not feature a dot in their name</li><li>archived git repositories should be ignored</li><li>git repositories that have no default branch should be ignored</li><li>in addition to being driven dynamically by <code>Dockerfile</code>s homed in git repositories (as described above), the automation should also support creating additional Grafana folders and dashboards from a static, hard-coded list provided via a YAML file</li></ol><p>While the above-listed requirements are a bit contrived, they offer an example scenario through which some more advanced, less obvious Terraform features can be exercised and demonstrated.</p><h2 id=solution-overview>Solution overview</h2><p>Before examining its code, here&rsquo;s an overview of some key aspects of the implementation:</p><ul><li>The <a href=https://registry.terraform.io/providers/integrations/github/latest/docs>GitHub Terraform provider</a>&rsquo;s data sources enable querying GitHub repositories via Terraform</li><li>In particular, the <a href=https://registry.terraform.io/providers/integrations/github/latest/docs/data-sources/tree><code>github_tree</code> data source</a> enables querying and analyzing repository contents, such as the existence of <code>Dockerfile</code>s and those files&rsquo; paths</li><li><code>for_each</code> and <code>for</code>/<code>in</code> enables looping and data transformation</li><li><code>if</code> enables conditional logic</li><li><code>locals</code> enable building custom data structures catering to the nuanced business requirements</li><li><code>try</code> enables gracefully handling errors and falling back to reliable default Terraform expressions if/when errors occur</li><li>various other Terraform functions such as <code>distinct</code>, <code>flatten</code>, <code>replace</code>, <code>lower</code>, <code>endswith</code>, <code>split</code>, <code>length</code>, <code>concat</code> further enable business logic, functionality, and formatting</li><li>The <a href=https://registry.terraform.io/providers/grafana/grafana/latest/docs>Grafana Terraform provider</a> enables the management of Grafana folders and dashboards via Terraform</li></ul><h2 id=solution-code>Solution code</h2><p><code>provider.tf</code> configures the necessary providers. Note that&mldr;</p><ul><li>For demonstration purposes, the configuration targets a local Grafana using hard-coded authentication credentials. In a real-world scenario, the configuration would likely target a real, remote Grafana URL, and would not expose hard-coded credentials.</li><li>For demonstration purposes, the configuration does not configure a <a href=https://developer.hashicorp.com/terraform/language/settings/backends/configuration>remote state backend</a>, though a real-world configuration likely would.</li><li>The GitHub provider is configured to target the GitHub organization specified as <code>local.owner</code> (stay tuned on this&mldr;).</li></ul><p><code>provider.tf</code>:</p><script type=application/javascript src="https://gist.github.com/mdb/e14382aded52a7890203ba9cf3b0610d.js?file=provider.tf"></script><p><code>data.tf</code> uses data sources provided by the GitHub provider to query GitHub repositories via the GitHub API and, ultimately, fetch a file tree representing the files in each repository&rsquo;s default branch across the targeted GitHub organization.</p><p><code>data.tf</code>:</p><script type=application/javascript src="https://gist.github.com/mdb/e14382aded52a7890203ba9cf3b0610d.js?file=data.tf"></script><p><code>locals.tf</code>&mldr;</p><ul><li>specifies <a href=https://github.com/vinyldns>vinyldns</a> as the targeted GitHub organization (The use of the <code>vinyldns</code> organization is fairly arbitrary and chosen largely because its repositories feature <code>Dockerfile</code>s homed in root and non-root directories, thus simulating some of the above-listed assumptions driving the contrived example)</li><li>exercises logic building a <code>local.grafana_dashboards</code> data structure homing the properly formatted dashboard names and corresponding Grafana folder, themselves ultimately driven by the directory location of <code>Dockerfile</code>s across <a href=https://github.com/vinyldns>vinyldns</a> git repositories, and supplemented by a static list defined in an <code>additional_dashboards.yaml</code> file</li><li>exercises logic building a <code>local.grafana_folders</code> data structure homing a deduplicated list of <em>just</em> the Grafana folder names</li></ul><p><code>locals.tf</code>:</p><script type=application/javascript src="https://gist.github.com/mdb/e14382aded52a7890203ba9cf3b0610d.js?file=locals.tf"></script><p><code>additional_dashboards.yaml</code>:</p><script type=application/javascript src="https://gist.github.com/mdb/e14382aded52a7890203ba9cf3b0610d.js?file=additional_dashboards.yaml"></script><p>&mldr;and, finally, <code>grafana.tf</code> enables the creation of&mldr;</p><ul><li>a Grafana folder for each item in <code>local.grafana_folders</code></li><li>a Grafana dashboard whose name and title correspond to the <code>dashboard</code> attribute of each object in the <code>local.grafana_folders</code></li></ul><p><code>grafana.tf</code>:</p><script type=application/javascript src="https://gist.github.com/mdb/e14382aded52a7890203ba9cf3b0610d.js?file=grafana.tf"></script><p>Note that&mldr;</p><ul><li>In this example, the Grafana dashboard JSON is deliberately simple. However, Terraform offers options for templating more complex Grafana JSON too, either via Terraform&rsquo;s own <a href=https://developer.hashicorp.com/terraform/language/functions/templatefile>templatefile function</a> or even via <a href=https://jsonnet.org/>jsonnet</a>, perhaps in concert with <a href=https://grafana.github.io/grafonnet-lib/>grafonnet</a> and even a <a href=https://registry.terraform.io/providers/alxrem/jsonnet/latest/docs>Terraform jsonnet provider</a>, <a href=https://grafana.github.io/grizzly/>grizzly</a>, or other templating technologies.</li><li>The <a href=https://registry.terraform.io/providers/grafana/grafana/latest/docs>Grafana Terraform provider</a> offers resources for managing many other aspects of Grafana too, such as teams, API keys, etc. A real-world example might manage additional Grafana resources via Terraform. For example, Terraform could manage the creation of a unique Grafana API key for each git repository in the targeted organization, and seed that key in a corresponding <code>GRAFANA_API_KEY</code> <a href=https://registry.terraform.io/providers/integrations/github/latest/docs/resources/actions_secret>GitHub Actions secret</a> in each repository. This would then enable the repositories&rsquo; GitHub Actions workflows to programmatically interact with Grafana, thereby empowering further platform automation capabilities.</li></ul><h2 id=summary-disclaimers-etc>Summary, Disclaimers, etc.</h2><p>Again, the above-described example is somewhat contrived. In particular, because the implementation uses GitHub provider data sources to dynamically drive the dashboards and folder names, each <code>terraform apply</code> invocation could yield differing results if/when modifications to the underlying git repositories and/or their <code>Dockerfile</code>s are performed between <code>apply</code> invocations. For example&mldr;</p><ul><li>When new git repositories and microservices are created, a subsequent <code>terraform apply</code> is necessary to create their corresponding Grafana folders and dashboards. If necessary, this could be orchestrated via automation that invokes <code>terraform apply</code> in response to relevant <a href=https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads>GitHub organization webhook events</a>.</li><li>When git repositories and/or microservices are deleted, a subsequent <code>terraform apply</code> could inadvertently result in the corresponding Grafana resources&rsquo; destruction. If undesired, this could be mitigated via the use of the <a href=https://developer.hashicorp.com/terraform/tutorials/state/resource-lifecycle#prevent-resource-deletion>prevent_destroy</a> lifecyle argument, or by hardcoding such dashboards and folders in the <code>additional_dashboards.yaml</code> file. Alternatively, the use of the GitHub provider data sources could be reevaluated or evolved to better account real-world needs.</li></ul><p>The above-described example is merely intended to showcase a few Terraform capabilities, and to inspire ideas. In addition to demonstrating semi-advanced logic, the configuration also teases some broader ideas for automating platform onboarding across an organization: While the example focuses largely on Grafana resources, the pattern could be applied to bootstrap other aspects of platform engineering across other non-Grafana providers For example&mldr;</p><ul><li>PagerDuty configurations</li><li>artifact repositories</li><li>Vault secrets</li><li>AWS resources, or even AWS account provisioning</li><li>Kubernetes namespaces and other Kubernetes resources</li><li>etc.</li></ul><p>See <a href=https://github.com/mdb/terraform-advanced-logic-demo>github.com/mdb/terraform-advanced-logic-demo</a> for the complete Terraform configuration.</p></div><ul class=tags><li><a href=/tags/terraform>terraform</a></li><li><a href=/tags/grafana>grafana</a></li><li><a href=/tags/platform-engineering>platform engineering</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built backend services, automated cloud infrastructure management, designed CI/CD pipelines for high scale distributed systems, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.c5a8c9d7a6d7af5e9ec023b4d48b27ce7c99395d13134fe4e192649a548829db.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Rails API Integration Tests | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.1793cf78540015f52d445efeea219c2a3ab4bc17725ba6b8caf459edd42ba3ae.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>April 17, 2014</time><article><header><h1>Rails API Integration Tests</h1></header><div><p>A web-services-oriented architecture encourages the development of multiple, modular applications over maintaining a single large, all-in-one monolithic piece of software. Often, the web services paradigm involves the development of clients apps that rely upon third party RESTful web services. Labor and responsibilities are divided and conquered across smaller, more manageable codebases and teams. But how can such a client application verify graceful integration? With a large user-base, such insight is increasingly critical.</p><p><b>Example</b>: You&rsquo;re deploying a Rails application that consumes a third party REST API, massages its data, and serves JSON. Unit tests stub HTTP requests with webmock; they verify that the application behaves as expected given prescribed data scenarios. But how do you ensure that both the upstream service, as well as your application, <i>actually</i> integrate as expected in a production scenario with real HTTP transactions, not just the stubbed responses you anticipate? How will you know in advance if your release candidate fails to gracefully handle an unnoticed third party API change? Or if you&rsquo;ve introduced a bug in consuming third party data?</p><p>API versioning and hypermedia standards such as <a href=http://stateless.co/hal_specification.html>HAL</a> promise non-breaking changes. From this perspective such verification is arguably unnecessary. But what about human error and unanticipated problems? Mistakes happen. And what about services that don&rsquo;t promise non-breaking changes?</p><p><b>Solution</b>: Simple Rspec integration tests ensure your application appropriately handles real HTTP requests against the third party service. The following offers a basic pattern in Rails. I assume you&rsquo;re using <a href=http://rspec.info/>Rspec</a> and that your unit tests stub HTTP request with <a href=https://github.com/bblimke/webmock>webmock</a>.</p><p>Create a <code>config/environments/integration.rb</code> config file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># inherit the test.rb config values</span>
</span></span><span style=display:flex><span>load(<span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;config&#34;</span>, <span style=color:#e6db74>&#34;environments&#34;</span>, <span style=color:#e6db74>&#34;test.rb&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>YourApp</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Application</span><span style=color:#f92672>.</span>configure <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># integration-specific overrides can go here</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Create some conditional logic in your <code>spec_helper.rb</code> surrounding This excludes Rspec tests tagged <code>:integration</code> unless the <code>RAILS_ENV</code> environment variable is set to &lsquo;integration&rsquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>RSpec</span><span style=color:#f92672>.</span>configure <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>filter_run_excluding <span style=color:#e6db74>:integration</span> <span style=color:#66d9ef>unless</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;RAILS_ENV&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;integration&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># disables HTTP requests for all non-integration tests</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WebMock</span><span style=color:#f92672>.</span>disable_net_connect!
</span></span></code></pre></div><p>Create an integration test file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ touch spec/integration/api/user_spec.rb
</span></span></code></pre></div><p>And add the following test code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;spec_helper&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>describe <span style=color:#e6db74>&#34;/api/user&#34;</span>, <span style=color:#e6db74>:integration</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  subject { response }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  before <span style=color:#e6db74>:each</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WebMock</span><span style=color:#f92672>.</span>disable!
</span></span><span style=display:flex><span>    get <span style=color:#e6db74>&#39;api/user&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  context <span style=color:#e6db74>&#34;the API requests succeed as expected&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    its(<span style=color:#e6db74>:status</span>) { should eq <span style=color:#ae81ff>200</span> }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  context <span style=color:#e6db74>&#34;verifying its JSON attributes&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    subject { <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>parse(response<span style=color:#f92672>.</span>body) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    its(<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;username&#39;</span><span style=color:#f92672>]</span>) { should eq <span style=color:#e6db74>&#39;mdb&#39;</span> }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Create a Rake task to run the integration tests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ touch lib/tasks/integration.rake
</span></span></code></pre></div><p>With the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;rspec/core/rake_task&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>namespace <span style=color:#e6db74>:integration</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  desc <span style=color:#e6db74>&#34;integration test the JSON API endpoints&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RSpec</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Core</span><span style=color:#f92672>::</span><span style=color:#66d9ef>RakeTask</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:test</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>t<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># set the RAILS_ENV such that :integration tagged</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># specs are run</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;RAILS_ENV&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;integration&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># only run those files in the &#39;integration&#39; directory</span>
</span></span><span style=display:flex><span>    t<span style=color:#f92672>.</span>pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./spec/integration{,/*/**}/*_spec.rb&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Run your integration tests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ rake integration:test
</span></span></code></pre></div><p>Integration tests can be run against each build. Such tests could also be run periodically against your production code, thus alerting the team should a breaking change our outtage occur.</p></div><ul class=tags><li><a href=/tags/ruby>ruby</a></li><li><a href=/tags/rspec>rspec</a></li><li><a href=/tags/continuous-integration>continuous integration</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built backend services, automated cloud infrastructure management, designed CI/CD pipelines for high scale distributed systems, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.c5a8c9d7a6d7af5e9ec023b4d48b27ce7c99395d13134fe4e192649a548829db.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
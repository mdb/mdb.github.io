<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Multi-stage Docker Builds | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/main.min.6e0e0a64d0252280a51bc82da0aa9d199ae3f51abeb927b5824806c9df80bf5f.css></head><body class=DEV><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>July 7, 2021</time><article><header><h1>Multi-stage Docker Builds</h1></header><div><p><em>An introduction to leveraging multi-stage container image builds.</em></p><h2 id=problem>Problem</h2><p>Your application is deployed via a minimal <a href=https://opencontainers.org/>OCI</a> image, such as one produced by a <a href=https://docs.docker.com/engine/reference/commandline/build/>Docker build</a>. However, its build and test pipeline consists of many stages, each of which utilizes disparate technologies, system dependencies, and testing techniques. Consistently managing the build pipeline &ndash; and its dependencies &ndash; across local development environments and CI/CD systems is complicated. Perhaps its configuration and dependency management is spread across <a href=https://docs.npmjs.com/cli/v7/configuring-npm/package-json#scripts>package.json</a> scripts, <a href=https://stackoverflow.com/questions/2270643/what-is-a-make-target/2270701>Make</a> targets, <a href=https://github.com/features/actions>Github Actions</a> YML, a <a href=https://www.jenkins.io/doc/book/pipeline/jenkinsfile/>Jenkinsfile</a>, a <a href=https://brew.sh/>homebrew</a> <code>Brewfile</code>, a <code>Dockerfile</code>, and/or Linux package managers with no consistent entrypoint.</p><h2 id=a-potential-solution>A potential solution</h2><p>Consider leveraging <a href=https://docs.docker.com/develop/develop-images/multistage-build/>multi-stage <code>docker</code> image builds</a> and leaning into Docker (or another <a href=https://opencontainers.org/>OCI image technology</a>) as the standard, streamlined entrypoint and lowest common dependency used to consistently build and test your software across all environments.</p><h2 id=a-basic-example>A basic example</h2><p>Consider a simple, contrived example in which a <code>hello</code> application is deployed via a container image.</p><p>When built and run, the <code>hello</code> application prints <code>hello</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build --tag hello .
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Building 0.9s <span style=color:#f92672>(</span>7/7<span style=color:#f92672>)</span> FINISHED
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run hello
</span></span><span style=display:flex><span>hello
</span></span></code></pre></div><h3 id=before>Before</h3><p>Prior to leveraging multi-stage Docker builds, <code>hello</code> is built via a minimal <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> hello.sh /hello.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/hello.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>&mldr;where <code>hello.sh</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span></code></pre></div><p>However, before building the <code>hello</code> image, the CI/CD and local build processes might subject <code>hello.sh</code> to <a href=https://github.com/koalaman/shellcheck>shellcheck</a> analysis, ensuring that the script conforms to common shell script conventions and contains no syntax errors.</p><p>In local development, the installation and invocation of <code>shellcheck</code> might be managed via a <code>Makefile</code>. In CI/CD, <code>shellcheck</code> might be invoked via the <a href=https://github.com/marketplace/actions/shellcheck>action-shellcheck</a> GitHub Action prior to a <a href=https://github.com/marketplace/actions/build-and-push-docker-images>GitHub Actions-based Docker build</a>.</p><h3 id=after>After</h3><p>Rather than manage multiple <code>shellcheck</code> installation and invocation techniques, perhaps the build process could be streamlined via a multi-stage image build in which <code>shellcheck</code> is invoked directly from within the <code>docker build</code>. The following <code>Dockerfile</code> does so via a <code>shellchecker</code> stage that must succeed before building the final image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> koalaman/shellcheck-alpine AS shellchecker</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> hello.sh /hello.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> shellcheck /*.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>shellchecker /hello.sh /hello.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/hello.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>In leveraging the multi-stage <code>Dockerfile</code>:</p><ul><li><code>docker</code> becomes the sole build-and-run-time dependency across all environments</li><li><code>shellcheck</code> is installed and invoked in a standard way across both local development and CI/CD environments; the disparate <code>Makefile</code>-based and GitHub Actions-based <code>shellcheck</code> installation/invocation code can be deleted</li></ul><p>Also note that the final <code>hello</code> image remains sufficiently minimal; <code>shellcheck</code> is only installed during the <code>shellchecker</code> stage and is not present in the final <code>hello</code> image.</p><h2 id=summary>Summary</h2><p>While the <code>hello</code> example is fairly simplistic and contrived, multi-stage Docker builds could be far more sophisticated, executing application compilation, unit tests, functional tests, and even integration tests from within the Docker build.</p><p>Utilizing multi-stage Docker builds to streamline build and test processes may not be appropriate in all contexts. However, the technique&rsquo;s worth considering and may simplify many workflows.</p></div><ul class=tags><li><a href=/tags/docker>docker</a></li><li><a href=/tags/containers>containers</a></li><li><a href=/tags/ci/cd>CI/CD</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end UIs, server backends, automated cloud infrastructure provisioning, built continuous deployment pipelines for highly available applications, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.da52d8ec13bd557c9a5cee7d197a95ba9bbe47f8ba6e93b2a4ac2ca9ac18b707.js></script></body></html>
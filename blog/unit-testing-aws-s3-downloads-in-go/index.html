<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Unit Testing AWS S3 Downloads in Go | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="How can a function wrapping the aws-sdk-go be unit tested using a local directory serving as a mock AWS S3 bucket?"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.43101f9fa16a173ab918363cb6d5b92e9321471b85fdc7d27df76d474d530401.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=/instagram>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><article><header><h1>Unit Testing AWS S3 Downloads in Go</h1><time>August 25, 2023</time></header><div><p><em>An example of <code>github.com/aws/aws-sdk-go/awstesting/unit</code>&rsquo;s use.</em></p><h2 id=problem>Problem</h2><p>How do you unit test a Go function that wraps <code>aws-sdk-go</code>&rsquo;s
<a href=https://pkg.go.dev/github.com/aws/aws-sdk-go/service/s3/s3manager#Downloader.Download>s3manager#Downloader.Download</a>
without issuing real HTTP requests to the AWS API (and without using an additional tool like <a href=https://localstack.cloud/>localstack</a>)?</p><h2 id=solution>Solution</h2><p>Make the implementation&rsquo;s <code>*s3manager.Downloader</code> configurable; in testing, use the
<code>github.com/aws/aws-sdk-go/awstesting/unit</code> package to create a custom
<code>*s3manager.Downloader</code> that uses a local <code>testdata</code> directory as a mock AWS S3 bucket.</p><h2 id=example>Example</h2><p>Consider a contrived <code>s3object</code> package. The package provides an <code>S3Object</code>
type, which features a <code>Download</code> method that wraps <a href=https://pkg.go.dev/github.com/aws/aws-sdk-go/service/s3/s3manager#Downloader.Download>s3manager#Downloader.Download</a>
and adds some extra logic.</p><p>By default, its <code>New</code> constructor configures a <code>*s3manager.Downloader</code> on the user&rsquo;s behalf. However, the constructor also
accepts a <code>WithDownloader</code> <a href=https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis>functional option</a>
for optionally configuring the use of a non-default <code>*s3manager.Downloader</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>s3object</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net/url&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/aws&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/service/s3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/service/s3/s3manager&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// S3Object is an S3 object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>S3Object</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>downloader</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>Downloader</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// S3ObjectOption is a functional option used to configure a new *S3Object.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>S3ObjectOption</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>s3o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S3Object</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WithDownloader is a DownloaderOption for configuring the use of a specific
</span></span></span><span style=display:flex><span><span style=color:#75715e>// *s3manager.Downloader.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithDownloader</span>(<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>Downloader</span>) <span style=color:#a6e22e>S3ObjectOption</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>s3o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S3Object</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s3o</span>.<span style=color:#a6e22e>downloader</span> = <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New returns a new *S3Object using the *url.URL it&#39;s passed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>u</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>S3ObjectOption</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>S3Object</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sess</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Must</span>(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>NewSession</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Region</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;us-east-1&#34;</span>),
</span></span><span style=display:flex><span>  }))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>downloader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>NewDownloader</span>(<span style=color:#a6e22e>sess</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s3o</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>S3Object</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>downloader</span>: <span style=color:#a6e22e>downloader</span>,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opt</span>(<span style=color:#a6e22e>s3o</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s3o</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Download downloads the S3 object from the URL it&#39;s passed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// It saves the object to a local file named after the last part of the URL&#39;s path.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s3o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>S3Object</span>) <span style=color:#a6e22e>Download</span>(<span style=color:#a6e22e>u</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Path</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>LastIndex</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>fileName</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s3o</span>.<span style=color:#a6e22e>downloader</span>.<span style=color:#a6e22e>Download</span>(<span style=color:#a6e22e>file</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>GetObjectInput</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Bucket</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Host</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>:    <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Path</span>),
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using the <code>github.com/aws/aws-sdk-go/awstesting/unit</code> package, a test
<code>*s3manager.Downloader</code> can be created, provided below via the <code>testDownloader()</code>
function. In this case, the <code>*s3manager.Downloader</code> provided by <code>testDownloader()</code>
treats a local <code>testdata</code> directory as a mock S3 bucket.</p><p>The <code>s3object.New</code> constructor&rsquo;s support for a <code>WithDownloader</code> functional
option enables the <code>s3object.Object</code> under test to use the
<code>*s3manager.Downloader</code> provided by <code>testDownloader()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>s3object_test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net/url&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/aws/request&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/awstesting/unit&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/service/s3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/aws/aws-sdk-go/service/s3/s3manager&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/mdb/s3object&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>testDownloader</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>Downloader</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>locker</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>svc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>unit</span>.<span style=color:#a6e22e>Session</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Handlers</span>.<span style=color:#a6e22e>Send</span>.<span style=color:#a6e22e>Clear</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Handlers</span>.<span style=color:#a6e22e>Send</span>.<span style=color:#a6e22e>PushBack</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>locker</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>locker</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span>{
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Header</span>: <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Header</span>{},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;testdata%s&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPRequest</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>nil</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If there&#39;s no error reading the file, return a 200 HTTP response with
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// the file contents as the response body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>StatusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>Body</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>NopCloser</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>f</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Otherwise, return a 500 HTTP response with the error as the body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>StatusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>Body</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>NopCloser</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// But, if the error occurs because the file doesn&#39;t exist, return a 404
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// HTTP response.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IsNotExist</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>StatusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusNotFound</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HTTPResponse</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Length&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>NewDownloaderWithClient</span>(<span style=color:#a6e22e>svc</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>Downloader</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Concurrency</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>PartSize</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestDownload</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>desc</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expectedErr</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>  }{{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>desc</span>:        <span style=color:#e6db74>&#34;does not exist&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span>:        <span style=color:#e6db74>&#34;testdata/does-not-exist/bim.txt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expectedErr</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  }, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>desc</span>:        <span style=color:#e6db74>&#34;exists&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span>:        <span style=color:#e6db74>&#34;testdata/foo/bar.txt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expectedErr</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  }}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>desc</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;s3://%s&#34;</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>path</span>))
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>newFileName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Path</span>[<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>LastIndex</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#e6db74>&#34;/&#34;</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Cleanup</span>(<span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>newFileName</span>) })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>s3o</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3object</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>s3object</span>.<span style=color:#a6e22e>WithDownloader</span>(<span style=color:#a6e22e>testDownloader</span>()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s3o</span>.<span style=color:#a6e22e>Download</span>(<span style=color:#a6e22e>u</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expectedErr</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expectedErr</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;expected error&#34;</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expectedErr</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>originalFileContent</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;unable to read file: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>newFileContent</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>newFileName</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;unable to read file: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> string(<span style=color:#a6e22e>originalFileContent</span>) <span style=color:#f92672>!=</span> string(<span style=color:#a6e22e>newFileContent</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected %s contents to equal %s&#34;</span>, <span style=color:#a6e22e>newFileName</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The project directory looks like the following; note the <code>testdata</code> directory,
which serves as the fake S3 bucket used in tests:</p><pre tabindex=0><code>├── go.mod
├── go.sum
├── s3object.go
├── s3object_test.go
└── testdata
    └── foo
        └── bar.txt

3 directories, 5 files
</code></pre></div><ul class=tags><li><a href=/tags/go>go</a></li><li><a href=/tags/s3>s3</a></li><li><a href=/tags/aws>aws</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built
backend services, automated cloud infrastructure management, designed
CI/CD pipelines for high scale distributed systems, designed developer
platforms for large organizations, and contributed to numerous
open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=https://clapclapexcitement.bsky.social>Bluesky</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.d9f9d7ac9e770ec8ebd0ed00e9c29649dd4e2983ac88a739b263f3862d69e26d.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
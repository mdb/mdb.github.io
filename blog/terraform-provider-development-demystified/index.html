<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Terraform Provider Development Demystified | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/main.min.efa3396db2ff62b75893504ed3912188d2aac65c27c68a3774bd2ca61bc3d9c5.css></head><body class=DEV><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>July 14, 2022</time><article><header><h1>Terraform Provider Development Demystified</h1></header><div><p><em>Many Terraform practitioners may be unfamiliar with <a href=https://www.terraform.io/language/providers>provider</a> development. How are providers actually implemented? The following offers an outline of a brief presentation I gave to the <a href=https://www.hbomax.com/>HBO Max</a> Strategic Global Infrastructure team.</em></p><h2 id=review-of-the-basics>Review of the basics</h2><p>First, let&rsquo;s establish a foundation, especially for those who may be less familiar with <a href=https://www.terraform.io/>Terraform</a>.</p><h3 id=terraform-fundamentals>Terraform fundamentals</h3><p>Terraform enables users to describe infrastructure resources &ndash; and their dependency relationships &ndash; in <code>.tf</code> files using <a href=https://github.com/hashicorp/hcl>HCL</a>, and to automate the creation and ongoing management of that infrastructure via the Terraform command line inferface.</p><p>HCL configurations often describe resources associated with cloud infrastructure services such as AWS, OpenStack, or Kubernetes, but they might also describe less cloudy resources, such as local files. For example, the following configuration creates a Digital Ocean droplet, a DNSSimple A record, and a local file documenting the resulting droplet&rsquo;s IP address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;digitalocean_droplet&#34; &#34;web&#34;</span> {
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tf-web&#34;</span>
</span></span><span style=display:flex><span>  size   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;512mb&#34;</span>
</span></span><span style=display:flex><span>  image  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;centos-5-8-x32&#34;</span>
</span></span><span style=display:flex><span>  region <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sfo1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;dnsimple_record&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  domain <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example.com&#34;</span>
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span>  value  <span style=color:#f92672>=</span> <span style=color:#66d9ef>digitalocean_droplet</span>.<span style=color:#66d9ef>web</span>.<span style=color:#66d9ef>ipv4_address</span>
</span></span><span style=display:flex><span>  type   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;local_file&#34; &#34;ip_address&#34;</span> {
</span></span><span style=display:flex><span>  content  <span style=color:#f92672>=</span> <span style=color:#66d9ef>digitalocean_droplet</span>.<span style=color:#66d9ef>web</span>.<span style=color:#66d9ef>ipv4_address</span>
</span></span><span style=display:flex><span>  filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/ip_address.txt&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When invoked against a configuration (i.e. a collection of resources specified as HCL in <code>*.tf</code> files like the example above) via the <code>terraform plan</code> and/or <code>terraform apply</code> CLI commands, Terraform builds a <a href=https://www.terraform.io/internals/graph>dependency graph</a> of resource attributes and relationships and analyzes&mldr;</p><ol><li>What has been specified in the <code>*.tf</code> files?</li><li>How does that compare to what&rsquo;s been captured in <a href=https://www.terraform.io/language/state>Terraform state</a>?</li><li>How does all that compare to what may or may not actually exist, as reported by the resources&rsquo; corresponding APIs?</li></ol><p>Based on its analysis, Terraform decides the order in which it must invoke the necessary CRUD actions (&ldquo;create,&rdquo; &ldquo;read,&rdquo; &ldquo;update,&rdquo; or &ldquo;destroy&rdquo;) against the resources&rsquo; APIs in order to produce the desired state, as specified in HCL configuration in <code>*.tf</code> files. I often refer to this logic as the &ldquo;Terraform lifecycle algorithm,&rdquo; though I may have made up that terminology; I don&rsquo;t know if the Terraform maintainers would view it as appropriate, though I find it helpful.</p><h3 id=terraform-providers>Terraform providers</h3><p>In Terraform parlance, <em>resources</em> (such as an individual DNS record) are associated with <em>providers</em> (such as DNSSimple or AWS Route 53). When declaring a resource in HCL in a <code>.tf</code> file, the provider name appears as the <code>${provider name}_</code> prefix. In the following example, Grafana is the provider associated with a folder resource:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;grafana_folder&#34; &#34;foo&#34;</span> {
</span></span><span style=display:flex><span>  uid   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>  title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Terraform Folder With UID foo&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As mentioned above, providers are often cloud infrastructure services such as AWS, OpenStack, Fastly, etc., but might also be&mldr;</p><ul><li>SaaS platforms such as Grafana, Heroku, GitHub, Okta, etc.</li><li>a local file system, etc.</li></ul><p>Generally speaking, a provider (and its underlying resource(s)) could be anything that can be modeled declaritively and has some sort of corresponding CRUD API(s).</p><p>Providers are decoupled from the Terraform CLI itself as independent software components, often versioned, compiled, and published to the <a href=https://registry.terraform.io/browse/providers>Terraform registry</a> via their own CI/CD processes. Typically, a Terraform provider&rsquo;s source code lives in a <code>git</code> repository conforming to the <code>terraform-provider-${PROVIDER}</code> naming convention.</p><p>Providers are generally authored in Go using Terraform&rsquo;s <a href=https://github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>. So, how does this work?</p><h2 id=implementing-a-provider>Implementing a provider</h2><p>A provider is configured in an individual Terraform configuration via a <code>provider "some_provider" {}</code>-style HCL configuration. For example, the AWS provider might be configured like&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>  version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3.40&#34;</span>
</span></span><span style=display:flex><span>  region  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us-east-1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Assuming the use of the <a href=https://github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>, a provider is implemented as a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Provider>*schema.Provider</a> on which a few key fields are specified, most notably fields like&mldr;</p><ul><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported provider arguments and attributes. See <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Schema>schema.Schema documentation</a> for more info.</li><li><code>ResourcesMap</code> - a <code>map[string]*schema.Resource</code> specifying the supported resources and their related functions</li><li><code>DataSourcesMap</code> - a <code>map[string]*schema.Resource</code> specifying the supported data sources and their related functions</li><li><code>ConfigureFunc</code> - a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#ConfigureFunc>ConfigureFunc</a> used to configure a provider, often creating and returning an API client using the provider configuration defined in <code>.tf</code> via the <code>provider "some_provider" {}</code> HCL.</li></ul><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/blob/master/grafana/provider.go>terraform-provider-grafana example</a></li><li><a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Provider>schema.Provider Godocs</a></li></ul><h2 id=resources>Resources</h2><p>Individual provider resources are managed via functions that return a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource>*schema.Resource</a> on which a few key fields are specified, most notably fields like&mldr;</p><ul><li><code>Description</code> - a description of the resource used to generate documentation</li><li><code>Create</code> - a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#CreateFunc>CreateFunc</a> function for creating the resource from configuration via the provider API</li><li><code>Read</code> - a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#ReadFunc>ReadFunc</a> function for reading the resource from configuration via the provider API</li><li><code>Update</code> - an <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#UpdateFunc>UpdateFunc</a> function for updating the resource from configuration via the provider API</li><li><code>Delete</code> - a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#DeleteFunc>DeleteFunc</a> function for deleting the resource if/when it&rsquo;s removed from configuration via the provider API</li><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported resource arguments and attributes. See <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Schema>schema.Schema documentation</a> for more info.</li><li>etc.</li></ul><p>Generally, each of the individual CRUD functions accept 2 arguments:</p><ol><li><a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#ResourceData>*schema.ResourceData</a> - this represents the Terraform configuration.</li><li>an <code>interface{}</code> - this is a generic interface often homing an API client package configured by the provider and used to interact with the provider APIs</li></ol><p>Each of the CRUD functions interact with the appropriate corresponding provider APIs to create, read, update, or delete the corresponding resource, accordingly. Each of the functions is also responsible for updating <a href=https://www.terraform.io/language/state>Terraform state</a> to reflect all this. However, it&rsquo;s business logic codified within Terraform itself &ndash; and not the provider codebase &ndash; that decides which of the CRUD functions to invoke when, via the aforementioned &ldquo;Terraform lifecycle algorithm.&rdquo;</p><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/558>an example PR implementing a grafana_annotation resource</a></li><li><a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource>schema.Resource Godocs</a></li><li><a href=https://learn.hashicorp.com/collections/terraform/providers>Terraform provider development tutorial</a></li></ul><h2 id=data-sources>Data sources</h2><p>Terraform <a href=https://www.terraform.io/language/data-sources>data sources</a> enable Terraform to <em>read</em> outside information. Unlike resources &ndash; which enable Terraform to create, update, and delete resources &ndash; data sources offer read-only functionality.</p><p>Assuming the use of the <a href=github.com/hashicorp/terraform-plugin-sdk>plugin SDK</a>, individual provider data sources are managed via functions that return a <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Resource>schema.Resource</a>, similar to that returned by resource functions. However, a data source&rsquo;s <code>*schema.Resource</code> typically only specifies:</p><ul><li><code>Description</code> - a description of the data source used to generate documentation</li><li><code>Read</code> - a function for reading the resource specified in configuration via the associated provider API</li><li><code>Schema</code> - a <code>map[string]*schema.Schema</code> specifying the supported resource arguments and attributes. See <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk/helper/schema#Schema>schema.Schema documentation</a> for more info.</li></ul><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/551>an example PR extending the grafana_organization data source to include new attributes</a></li></ul><h2 id=tying-it-together>Tying it together</h2><p>In summary, provider implementation is largely composed of boilerplate-ish configuration code implementing the above-described types. Most of the provider-specific business logic is confined to the individual CRUD functions associated with individual resources, and is itself mostly focused on provider-API-interaction and the surrounding reading and writing of Terraform state. Then, finally, a <code>main.go</code> provides the entry point for the provider program.</p><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/blob/master/main.go>terraform-provider-grafana example</a></li></ul><h2 id=gnumakefile>GNUmakefile</h2><p>Most provider codebases feature a <code>GNUmakefile</code> in which various build and test commands are specified.</p><h2 id=testing>Testing</h2><p>While individual functions can be unit tested in isolation, the plugin SDK provides an <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk@v1.17.2/helper/acctest>acctest</a> and testing utilities (most notably <a href=https://pkg.go.dev/github.com/hashicorp/terraform-plugin-sdk@v1.17.2/helper/resource#TestCase><code>resource.TestCase</code></a>) used to author acceptance tests against provider, provider resource, and provider data source functionality.</p><p>Generally, these acceptance tests are configured to interact with real APIs associated with a given cloud provider, though some Terraform providers &ndash; particularly those that target open source platforms or SaaS APIs &ndash; may configure acceptance tests to interact with <code>localhost</code>-served APIs enabled via tools such as <a href=https://www.docker.com/>Docker</a>. For example, <code>terraform-provider-grafana</code>&rsquo;s own acceptance testing utilizes a local Grafana established via <a href=https://github.com/grafana/terraform-provider-grafana/blob/v1.24.0/docker-compose.yml>docker-compose</a> in local development, as well as remote instances of Grafana in CI/CD.</p><p>To run <code>terraform-provider-grafana</code>&rsquo;s acceptance tests locally, install <a href=https://go.dev/>Go</a> and <a href=https://www.docker.com/>Docker</a>, then clone the repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone git@github.com:grafana/terraform-provider-grafana.git
</span></span></code></pre></div><p>&mldr;and run the acceptance tests against a local Docker-established Grafana:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make testacc-docker
</span></span></code></pre></div><p>To learn more:</p><ul><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/558>example PR adding tests of a new grafana_annotation resource</a></li><li><a href=https://github.com/grafana/terraform-provider-grafana/pull/551>example PR adding tests of new grafana_organization data source functionality</a></li><li><a href=https://drone.grafana.net/grafana/terraform-provider-grafana/1345>example terraform-provider-grafana PR Drone CI/CD execution</a></li></ul><h2 id=building>Building</h2><p>Typically, <a href=https://goreleaser.com/>goreleaser</a> is used to compile provider binaries across platforms and publish them as versioned GitHub releases. <a href=https://github.com/grafana/terraform-provider-grafana/blob/v1.24.0/.goreleaser.yml>terraform-provider-grafana&rsquo;s .goreleaser.yml</a> offers an example of a <code>goreleaser</code> configuration used to build and publish its own <a href=https://github.com/grafana/terraform-provider-grafana/releases>GitHub releases</a>.</p><p>Often, <a href=https://github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs>tfplugindocs</a> is integrated with providers&rsquo; build process to automate the generation of markdown documents documenting the provider; these are typically committed to a <a href=https://github.com/grafana/terraform-provider-grafana/tree/v1.24.0/docs>docs</a> directory in source control.</p><h2 id=releasing>Releasing</h2><p>Assuming the provider and its associated GitHub releases conform to some <a href=https://www.terraform.io/registry/providers/publishing>common standards</a>, the provider can be published to the <a href=https://www.terraform.io/registry/providers/publishing#publishing-to-the-registry>Terraform registry</a>. From there, it&rsquo;s available for use and can be downloaded by Terraform configurations in which it&rsquo;s referenced and configured.</p><h2 id=learn-more>Learn more</h2><p>In my experience, the codebase of an existing provider offers the best way to learn more, particularly that of a simple provider (as opposed to the <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs>terraform-provider-aws</a>, whose codebase is large and daunting). Maybe it&rsquo;s worth taking a look at something like <a href=https://github.com/nat-henderson/terraform-provider-dominos>terraform-provider-dominos</a>? For me, <code>git clone</code>-ing provider code locally, running tests, and looking for simple areas of improvement has taught me a lot. Maybe that&rsquo;s helpful for you too?</p><p>It&rsquo;s also worth looking at <a href=https://learn.hashicorp.com/collections/terraform/providers>HashiCorp&rsquo;s own learning resources</a>.</p><p>Do you see an inaccuracy or typo in this post? <a href=https://github.com/mdb/mdb.github.io>Submit a pull request</a>.</p></div><ul class=tags><li><a href=/tags/infrastructure>infrastructure</a></li><li><a href=/tags/golang>golang</a></li><li><a href=/tags/cloud>cloud</a></li><li><a href=/tags/terraform>terraform</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end UIs, server backends, automated cloud infrastructure provisioning, built continuous deployment pipelines for highly available applications, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.da52d8ec13bd557c9a5cee7d197a95ba9bbe47f8ba6e93b2a4ac2ca9ac18b707.js></script></body></html>
<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Go on Mike Ball</title><link>/tags/go/</link><description>Recent content in Go on Mike Ball</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Fri, 25 Aug 2023 00:00:00 +0000</lastBuildDate><atom:link href="/tags/go/index.xml" rel="self" type="application/rss+xml"/><item><title>Unit Testing AWS S3 Downloads in Go</title><link>/blog/unit-testing-aws-s3-downloads-in-go/</link><pubDate>Fri, 25 Aug 2023 00:00:00 +0000</pubDate><guid>/blog/unit-testing-aws-s3-downloads-in-go/</guid><description>&lt;p&gt;&lt;em&gt;An example of &lt;code&gt;github.com/aws/aws-sdk-go/awstesting/unit&lt;/code&gt;&amp;rsquo;s use.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id="problem"&gt;Problem&lt;/h2&gt;
&lt;p&gt;How do you unit test a Go function that wraps &lt;code&gt;aws-sdk-go&lt;/code&gt;&amp;rsquo;s
&lt;a href="https://pkg.go.dev/github.com/aws/aws-sdk-go/service/s3/s3manager#Downloader.Download"&gt;s3manager#Downloader.Download&lt;/a&gt;
without issuing real HTTP requests to the AWS API (and without using an additional tool like &lt;a href="https://localstack.cloud/"&gt;localstack&lt;/a&gt;)?&lt;/p&gt;
&lt;h2 id="solution"&gt;Solution&lt;/h2&gt;
&lt;p&gt;Make the implementation&amp;rsquo;s &lt;code&gt;*s3manager.Downloader&lt;/code&gt; configurable; in testing, use the
&lt;code&gt;github.com/aws/aws-sdk-go/awstesting/unit&lt;/code&gt; package to create a custom
&lt;code&gt;*s3manager.Downloader&lt;/code&gt; that uses a local &lt;code&gt;testdata&lt;/code&gt; directory as a mock AWS S3 bucket.&lt;/p&gt;
&lt;h2 id="example"&gt;Example&lt;/h2&gt;
&lt;p&gt;Consider a contrived &lt;code&gt;s3object&lt;/code&gt; package. The package provides an &lt;code&gt;S3Object&lt;/code&gt;
type, which features a &lt;code&gt;Download&lt;/code&gt; method that wraps &lt;a href="https://pkg.go.dev/github.com/aws/aws-sdk-go/service/s3/s3manager#Downloader.Download"&gt;s3manager#Downloader.Download&lt;/a&gt;
and adds some extra logic.&lt;/p&gt;</description></item><item><title>Extending the gh CLI with Go</title><link>/blog/extending-the-gh-cli-with-go/</link><pubDate>Wed, 28 Dec 2022 00:00:00 +0000</pubDate><guid>/blog/extending-the-gh-cli-with-go/</guid><description>&lt;p&gt;&lt;em&gt;GitHub&amp;rsquo;s &lt;a href="https://cli.github.com/"&gt;gh CLI&lt;/a&gt; can be enhanced via custom extensions. The following offers an introduction, as well as some notes and tips for doing so in Go.&lt;/em&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="#what?"&gt;What?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#extensions"&gt;Extensions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#how-do-gh-extensions-work"&gt;How do gh extensions work?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#implementation-tips-suggestions-etc"&gt;Implementation tips, suggestions, etc.&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#bonus-experimental-idea-bootstrapping-developer-experience-and-platform-engineering"&gt;Bonus experimental idea: bootstrapping developer experience and platform engineering&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#further-reading"&gt;Further reading&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="what"&gt;What?&lt;/h2&gt;
&lt;p&gt;Out of the box, the &lt;a href="https://cli.github.com/"&gt;gh CLI&lt;/a&gt; supports a collection of commands for interacting with GitHub features like repositories, releases, pull requests, and more. For example, to view a repository&amp;rsquo;s open pull requests, use &lt;code&gt;gh pr ls&lt;/code&gt;:&lt;/p&gt;</description></item><item><title>Go Test Parallelization</title><link>/blog/go-test-parallelization/</link><pubDate>Fri, 11 Jun 2021 00:00:00 +0000</pubDate><guid>/blog/go-test-parallelization/</guid><description>&lt;p&gt;&lt;em&gt;A brief introduction to using Go&amp;rsquo;s &lt;code&gt;testing&lt;/code&gt; package&amp;rsquo;s &lt;a href="https://golang.org/pkg/testing/#T.Parallel"&gt;&lt;code&gt;T.Parallel()&lt;/code&gt;&lt;/a&gt; to parallelize tests.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id="problem"&gt;Problem&lt;/h2&gt;
&lt;p&gt;Your Go project&amp;rsquo;s tests are slow and run serially. Or perhaps they&amp;rsquo;re not slow, but they run serially and could be faster.&lt;/p&gt;
&lt;h2 id="solution"&gt;Solution&lt;/h2&gt;
&lt;p&gt;Consider running the test cases in parallel.&lt;/p&gt;
&lt;h2 id="simple-non-parallelized-example"&gt;Simple non-parallelized example&lt;/h2&gt;
&lt;p&gt;As a starting point, consider a simple non-parallelized test:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-golang" data-lang="golang"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; (
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;io/ioutil&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;testing&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;func&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;TestSimple&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;testing&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;T&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;testCases&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; []&lt;span style="color:#66d9ef"&gt;struct&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;name&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }{{
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;1&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }, {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;2&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }, {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;3&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }, {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;4&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }, {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;5&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;t&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Logf&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;Running %s tests...&amp;#34;&lt;/span&gt;, len(&lt;span style="color:#a6e22e"&gt;testCases&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;i&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;tc&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;range&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;testCases&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;t&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Run&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;tc&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;name&lt;/span&gt;, &lt;span style="color:#66d9ef"&gt;func&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;testing&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;T&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;time&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Sleep&lt;/span&gt;(&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;time&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Second&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;expected&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;strconv&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Itoa&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;expected&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;tc&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;name&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;t&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;Errorf&lt;/span&gt;(&lt;span style="color:#e6db74"&gt;&amp;#34;expected index %s to equal test %s&amp;#34;&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;expected&lt;/span&gt;, &lt;span style="color:#a6e22e"&gt;tc&lt;/span&gt;.&lt;span style="color:#a6e22e"&gt;name&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; })
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The code leverages a common &lt;a href="https://dave.cheney.net/2019/05/07/prefer-table-driven-tests"&gt;table driven testing&lt;/a&gt; pattern: individual test case names are stored in a &lt;code&gt;testCases&lt;/code&gt; anonymous struct literal and each test case is subject to an assertion. To futher illustrate the benefits of parallelization, the code also sleeps for three seconds during each test case iteration.&lt;/p&gt;</description></item><item><title>Channels in Go</title><link>/blog/channels-in-go/</link><pubDate>Tue, 09 Jan 2018 00:00:00 +0000</pubDate><guid>/blog/channels-in-go/</guid><description>&lt;p&gt;Through &lt;code&gt;goroutines&lt;/code&gt; and &lt;code&gt;channels&lt;/code&gt;, Go offers constructs for concurrent programming. A &lt;code&gt;goroutine&lt;/code&gt; is a concurrent function execution, while a &lt;code&gt;channel&lt;/code&gt; offers a communication mechanism through which one &lt;code&gt;goroutine&lt;/code&gt; can pass values of a specific type to another &lt;code&gt;goroutine&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;For example, the following code performs three HTTP requests concurrently, reports back the request URL, the request response time, and its HTTP response status code for each request, and also the total time spent executing the program. In this example, the &lt;code&gt;channel&lt;/code&gt; receives a string summarizing the URL, response time, and status code details for each concurrent request, while the &lt;code&gt;main&lt;/code&gt; function prints each string sent to the &lt;code&gt;channel&lt;/code&gt;. The code illustrates that the total time spent executing the program is less than the sum of the times spent waiting for each individual HTTP response, as the HTTP requests are performed concurrently.&lt;/p&gt;</description></item></channel></rss>
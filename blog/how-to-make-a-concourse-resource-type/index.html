<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>How to Make a Concourse Resource Type | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.c5cd7095f5e0084c9c1443dd669fe45e35b608fb90a8fd34626d2125428e076f.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>October 29, 2019</time><article><header><h1>How to Make a Concourse Resource Type</h1></header><div><p><em>My notes and thoughts on Concourse resource types and when and how to build and test your own resource types</em>.</p><h2 id=context-and-background>Context and background</h2><p><em>Resources</em> are a core concept in <a href=https://concourse-ci.org>Concourse</a> CI/CD pipelines. A <a href=https://concourse-ci.org/resources.html>resource</a> is any entity that Concourse can check for new versions, fetch at a specific version, and/or push up changes to idempotently create new versions. In this sense, a resource &ldquo;version&rdquo; is a specific form of a resource that differs from earlier forms, such as a particular commit on a git repository or a particular build artifact object in an AWS S3 bucket. This may sound vague, but it&rsquo;s an arguably compelling feature. Because Concourse&rsquo;s notion of resources offers users a generic way to extend Concourse functionality &ndash; and because Concourse supports the use of custom <a href=https://concourse-ci.org/implementing-resource-types.html>resource-type implementations</a> &ndash; resources serve as a useful tool in building Concourse CI/CD pipelines. Pipeline authors can leverage Concourse&rsquo;s built-in resource types, use community-maintained resource types, or create new functionality through their own, custom resource types. And each implementation &ndash; whether it&rsquo;s a built-in resource type, a community-maintained resource type, or a custom, in-house resource type &ndash; is itself packaged and versioned software with its own build/test/release CI/CD lifecycle. In this sense, resource types emerge as an interesting model through which the the units of CI/CD pipeline functionality can be maintained and distributed as first class software projects, and not just ad hoc scripts and untested glue code, as has been historically common.</p><h2 id=built-in-resource-types>Built-in resource types</h2><p>Out of the box, Concourse ships with a few built-in <a href=https://concourse-ci.org/resource-types.html>resource types</a>. These &ldquo;official&rdquo; resource types are maintained by the Concourse development team and offer some common, core pipeline functionalities. A few of Concourse&rsquo;s built-in resource types are:</p><ul><li><a href=https://github.com/concourse/git-resource>git-resource</a> - used to interact with git repositories</li><li><a href=https://github.com/concourse/s3-resource>s3-resource</a> - used to interact with AWS S3</li><li><a href=https://github.com/concourse/docker-image-resource>docker-image-resource</a> - tracks and builds Docker images</li></ul><h2 id=community-maintained-resource-types>Community maintained resource types</h2><p>Beyond the built-in Concourse resources types, community maintained resource types add additional Concourse pipeline functionality. Complex CI/CD pipelines often use these community maintained resource types for non-basic, use-case-specific needs. A few popular examples include:</p><ul><li><a href=https://github.com/telia-oss/github-pr-resource>github-pr-resource</a> - used to interact with GitHub pull requests</li><li><a href=https://github.com/ljfranklin/terraform-resource>terraform-resource</a> - used to interact with Terraform</li><li><a href=https://github.com/cloudfoundry-community/slack-notification-resource>slack-notification-resource</a> - used to send notifications to Slack</li></ul><h2 id=implementing-a-concourse-resource-type-is-it-necessary>Implementing a Concourse resource type: Is it necessary?</h2><p>Before developing your own custom Concourse resource type, it&rsquo;s worth considering a few questions&mldr;</p><ol><li><p>Will an existing, community-maintained resource type suffice?</p><p>There are many open source, community-maintained Concourse resource types available for public use. In my experience, usually an existing resource type meets a pipeline&rsquo;s needs. Given this large community ecosystem, I rarely encounter a use case that warrants writing a new resource type from scratch.</p></li><li><p>Is a <em>resource</em> necessary or will a <a href=https://concourse-ci.org/tasks.html>task</a> suffice?</p><p>Resources are most compelling in their ability to <em>track</em> specific resource <em>versions</em> &ndash; such as a specific <a href=https://help.github.com/en/github/administering-a-repository/creating-releases>GitHub release</a>, for example &ndash; across multiple Concourse pipeline <a href=https://concourse-ci.org/jobs.html>jobs</a>. By serving as an external-to-Concourse mechanism through which pipelines can persist and fetch state, resources empower the ability to build pipelines composed of a sequence of jobs passing and operating on specific resource versions.</p><p>However, if it&rsquo;s not necessary to pass resource versions between multiple jobs (rather than between <a href=https://concourse-ci.org/tasks.html>tasks</a> <em>within</em> a job, which support the ability to operate on and pass directories as <a href=https://concourse-ci.org/tasks.html#input-name>inputs</a> and <a href=https://concourse-ci.org/tasks.html#output-name>outputs</a>), you may not need a resource. Instead, a simple <a href=https://concourse-ci.org/tasks.html>task</a> may meet your needs. In Concourse, <em>tasks</em> can be authored to run any command or script in any Docker image.</p></li></ol><h2 id=how-to-implement-a-resource-type-a-case-study>How to implement a resource type: a case study</h2><p><a href=https://github.com/mdb/concourse-consul-kv-resource>concourse-consul-kv-resource</a> is a Concourse resource I maintain for interacting with <a href=https://www.consul.io/>HashiCorp Consul</a>&rsquo;s key/value store. It offers a relatively simple example for learning more about how Concourse resources work.</p><p>At its core, implementing a custom Concourse resource type requires publishing a Docker image with 3 executables:</p><ol><li><code>/opt/resource/check</code> - responsible for checking for new versions of your resource</li><li><code>/opt/resource/in</code> - responsible for fetching specific versions of your resource</li><li><code>/opt/resource/out</code> - responsible for outputting new versions of your resource</li></ol><p>In the case of <code>concourse-consul-kv-resource</code>, its Docker image is published to <a href=https://hub.docker.com/r/clapclapexcitement/concourse-consul-kv-resource>hub.docker.com/r/clapclapexcitement/concourse-consul-kv-resource</a>. Provided a resource type Docker image properly implements the <code>check</code>, <code>in</code>, and <code>out</code> executables (more on this to follow), the source code itself can be authored in any programming language. <code>concourse-consul-kv-resource</code> is written in Node.js.</p><p>A very basic <a href=https://concourse-ci.org/pipelines.html>pipeline configuration</a> using <code>concourse-consul-kv-resource</code> might look like this (If you&rsquo;re unfamiliar with authoring Concourse pipelines, <a href=https://concoursetutorial.com>concoursetutorial.com</a> is a great place to start learning):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>resources_types</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># declare the use of a &#39;consul-kv&#39; resource type</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consul-kv</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>docker-image</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>clapclapexcitement/concourse-consul-kv-resource</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># configure an instance of the &#39;consul-kv&#39; resource type</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>consul-kv</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>my-consul.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key</span>: <span style=color:#ae81ff>my-key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># a basic job to fetch &#39;my-key&#39;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>get-my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># a basic job to update &#39;my-key&#39; to be &#39;my-new-value&#39;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>update-my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>put</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#ae81ff>my-new-value</span>
</span></span></code></pre></div><h2 id=the-check-action-optresourcecheck>The &ldquo;check&rdquo; action: <code>/opt/resource/check</code></h2><p><code>/opt/resource/check</code> is run to detect new versions of the resource. Resource type authors determine what constitutes a resource &ldquo;version&rdquo; on a per-implementation basis. In the case of <code>concourse-consul-kv-resource</code>, a version is a unique value of the Consul key specified in the resource&rsquo;s <a href=https://concourse-ci.org/resources.html#resource-source>source configuration</a>.</p><p>A resource <code>source</code> configuration allows users to declare data such as URLs, credentials, and other details informing the resource how to interact with third party providers, such as GitHub or the AWS API. The configurable <code>source</code> fields vary depending on a resource type&rsquo;s implementation and needs. As exemplified in the pipeline <code>yaml</code> above, a <code>concourse-consul-kv-resource</code> instance&rsquo;s <code>source</code> configuration contains data on a Consul&rsquo;s domain name and the specific K/V key of interest (other <a href=https://github.com/mdb/concourse-consul-kv-resource#source-configuration>source config options</a> are available as well):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>consul-kv</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>my-consul.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key</span>: <span style=color:#ae81ff>my-key</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>When invoked, <code>/opt/resource/check</code> is passed a JSON payload on <code>stdin</code>. The JSON payload includes the <code>source</code> configuration and resource <code>version</code> data.</p><p>Example <code>stdin</code> JSON provided to <code>/opt/resource/check</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;my-consul.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;my-key&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>/opt/resource/check</code> uses the data in this JSON to determine if new resource versions exist. It must print a JSON array of new versions to <code>stdout</code>. Because <code>concourse-consul-kv-resource</code> uses a Consul key&rsquo;s value as its version, <code>/opt/resource/check</code> uses the data provided in <code>source</code> to check the <code>source.host</code> Consul instance for a new <code>source.key</code> value that differs from the current <code>version.value</code> passed via the <code>stdin</code> JSON.</p><p>If the key in Consul has a new value, <code>/opt/resource/check</code> outputs JSON such as the following to <code>stdout</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-new-value&#34;</span>
</span></span><span style=display:flex><span>}]
</span></span></code></pre></div><p>If the key does not have a new value, <code>/opt/resource/check</code> outputs an empty JSON array to <code>stdout</code>, indicating that no new versions were discovered:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[]
</span></span></code></pre></div><h2 id=the-in-action-optresourcein>The &ldquo;in&rdquo; action: <code>/opt/resource/in</code></h2><p><code>/opt/resource/in</code> is run to fetch a specific version of the resource. In the case of <code>concourse-consul-kv-resource</code>, <code>/opt/resource/in</code> is implemented to always fetch the configured Consul key&rsquo;s current value.</p><p>When invoked, <code>/opt/resource/in</code> is provided a JSON payload on <code>stdin</code> containing the <code>source</code> and <code>version</code> data, similar to the JSON provided <code>/opt/resource/check</code>.</p><p>Example <code>stdin</code> provided to <code>/opt/resource/in</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;my-consul.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;my-key&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In addition to the JSON payload, <code>/opt/resource/in</code> is passed the name of a &ldquo;destination&rdquo; directory as a single argument. The resource may write resource version data &ndash; downloads, files, metadata, etc. &ndash; to this &ldquo;destination&rdquo; directory such that downstream job <a href=https://concourse-ci.org/steps.html>steps</a> can use these files and data. The &ldquo;destination&rdquo; directory&rsquo;s name is determined by the string specified as a job&rsquo;s <a href=https://concourse-ci.org/get-step.html#get-step-get>get step</a>.</p><p><code>concourse-consul-kv-resource</code>&rsquo;s <code>/opt/resource/in</code> uses the data provided in the <code>stdin</code> JSON <code>source</code> to fetch the <code>source.key</code> value from the <code>source.host</code> Consul instance and write its value to a file in the destination directory. For example, given the above <code>stdin</code> JSON &ndash; and assuming the <code>my-key</code>&rsquo;s value in Consul is &ldquo;some value&rdquo; &ndash; the following pipeline job configuration results in an invocation of <code>/opt/resource/in</code> that writes &ldquo;some-value&rdquo; to a <code>my-consul-key/my-key</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>get-my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span></code></pre></div><p><code>/opt/resource/in</code> must also ouput JSON to <code>stdout</code> denoting <code>version</code> and <code>metadata</code> in a standard format. The <code>metadata</code> is an array of key/value pairs denoting version-specific details of interest. Metadata is displayed on the Concourse web UI&rsquo;s build page to offer users helpful details on a particular version.</p><p>For example, <code>concourse-consul-kv-resource</code>&rsquo;s <code>/opt-resource/in</code> produces <code>stdout</code> JSON like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;metadata&#34;</span>: [{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>,
</span></span><span style=display:flex><span>  }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=the-out-action-optresourceout>The &ldquo;out&rdquo; action: <code>/opt/resource/out</code></h2><p><code>/opt/resource/out</code> is run to produce a new version of a resource. In the case of <code>concourse-consul-kv-resource</code>, <code>/opt/resource/out</code> updates the Consul key specified in <code>source.key</code> with a new value.</p><p>When invoked, <code>/opt/resource/out</code> is provided a <code>stdin</code> JSON payload containing <code>source</code> configuration and <code>params</code> data. <code>params</code> is an arbitrary key/value map of parameters. The supported <code>params</code> values vary between resource type implementations. <code>concourse-consul-kv-resource</code> supports two <code>params</code> keys:</p><ul><li><code>value</code> - a string specifying the new Consul K/V key&rsquo;s value</li><li><code>file</code> - the path to a file in which the new Consul K/V key&rsquo;s value is written</li></ul><p>For example, the following job step configuration results in a <code>stdin</code> JSON payload whose <code>params.value</code> field&rsquo;s value is &ldquo;new-value:&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>update-my-consul-key</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>put</span>: <span style=color:#ae81ff>my-consul-key</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;new-value&#34;</span>
</span></span></code></pre></div><p>Assuming a basic <code>source</code> coniguration, the full <code>stdin</code> JSON would look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;my-consul.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;my-key&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-new-out-value&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Like <code>in</code>, <code>/opt/resource/out</code> must print JSON to <code>stdout</code> denoting <code>version</code> and <code>metadata</code> in a standard format. <code>concourse-consul-kv-resource</code>&rsquo;s <code>/opt-resource/out</code> produces <code>stdout</code> JSON like the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;metadata&#34;</span>: [{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;some-value&#34;</span>,
</span></span><span style=display:flex><span>  }, {
</span></span><span style=display:flex><span>   <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;timestamp&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;1572210671189&#34;</span>,
</span></span><span style=display:flex><span>  }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=execute-the-resource-check-in-and-out-locally>Execute the resource <code>check</code>, <code>in</code>, and <code>out</code> locally</h2><p>Assuming <a href=https://www.docker.com/>Docker</a> is installed, a resource type&rsquo;s <code>check</code>, <code>in</code>, and <code>out</code> implementations can be invoked via a <code>docker run</code> to exercise and validate their behavior.</p><p>To exercise <code>concourse-consul-kv-resource</code>&rsquo;s functionality, it&rsquo;s also necessary to have a Consul for the resource to read from and write to. Let&rsquo;s start a Consul on <code>localhost:8500</code> using <code>docker-compose</code>.</p><p>First, create a <code>docker-compose.yml</code>. Paste the following into your terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; docker-compose.yml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>version: &#39;3&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>services:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  consul:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    image: consul
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ports:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - 8500:8500
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Next, use the newly created <code>docker-compose.yml</code> to start the local <code>docker-compose</code>&rsquo;d Consul on a network named <code>kv-resource_default</code> (<code>docker-compose</code> networks are named <code>${project-name}_default</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --project-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kv-resource&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  up <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --detach
</span></span></code></pre></div><p>Note that this makes the the Consul resolvable via a <code>consul</code> hostname for any other services on the <code>kv-resource_default</code> network.</p><p>Let&rsquo;s also use <code>curl</code> to interact with the Consul K/V API to seed the <code>localhost:8500</code> Consul with a <code>my-key</code> key whose value is &ldquo;my-value:&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --request <span style=color:#e6db74>&#34;PUT&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#34;my-value&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://localhost:8500/v1/kv/my-key
</span></span></code></pre></div><h2 id=an-example-optresourcecheck-invocation>An example <code>/opt/resource/check</code> invocation</h2><p>Store the <code>stdin</code> JSON in a file for convenience by pasting the following into your terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; check_request.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;source&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;host&#34;: &#34;consul&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;protocol&#34;: &#34;http&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;skip_ssl_check&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key&#34;: &#34;my-key&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;version&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;value&#34;: &#34;my-value&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Invoke the <code>check</code> using the <code>check_request.json</code> as <code>stdin</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat check_request.json | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  docker run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network<span style=color:#f92672>=</span>kv-resource_default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --interactive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    clapclapexcitement/concourse-consul-kv-resource <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      /opt/resource/check<span style=color:#e6db74>&#34;
</span></span></span></code></pre></div><p>Because the <code>version.value</code> specified in the JSON matches the <code>my-key</code>&rsquo;s current value in Consul, you should see an empty array printed to <code>stdout</code>, indicating there are no new versions of <code>my-key</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[]
</span></span></code></pre></div><p>To see how <code>check</code> behaves when the <code>version.value</code> value is different from the <code>my-key</code>&rsquo;s current value in Consul, update <code>my-key</code>&rsquo;s value in Consul:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --request <span style=color:#e6db74>&#34;PUT&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#34;my-new-value&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://localhost:8500/v1/kv/my-key
</span></span></code></pre></div><p>A re-execution of the above-cited <code>docker run</code> command now prints the following JSON to <code>stdout</code>, indicating that <code>check</code> has discovered a new version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-new-value&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h2 id=an-example-optresourcein-invocation>An example <code>/opt/resource/in</code> invocation</h2><p>Store the <code>stdin</code> JSON in a file for convenience:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; in_request.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;source&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;host&#34;: &#34;consul&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;protocol&#34;: &#34;http&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;skip_ssl_check&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key&#34;: &#34;my-key&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;version&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;value&#34;: &#34;my-value&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Invoke the <code>in</code> using the <code>in_request.json</code> as <code>stdin</code> and write the <code>my-key</code> to a <code>dest/my-key</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat in_request.json | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  docker run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network<span style=color:#f92672>=</span>kv-resource_default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --volume <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/dest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --interactive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    clapclapexcitement/concourse-consul-kv-resource <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      /opt/resource/in /dest<span style=color:#e6db74>&#34;
</span></span></span></code></pre></div><p>Note that, because the above <code>docker run</code> mounts your host machine&rsquo;s (i.e. the machine on which the <code>docker run</code> is executed) current working directory at <code>/dest</code>, this results in a <code>my-key</code> file in your host machine&rsquo;s current working directory. This also prints the following JSON to <code>stdout</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-value&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;metadata&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-value&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Confirm that the <code>my-key</code> file was written to your current working directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat my-key
</span></span><span style=display:flex><span>my-value
</span></span></code></pre></div><h2 id=an-example-optresourceout-invocation>An example <code>/opt/resource/out</code> invocation</h2><p>Next, let&rsquo;s invoke <code>/op/resource/out</code> with <code>stdin</code> JSON that updates the <code>my-key</code>&rsquo;s value to a &ldquo;my-new-value-from-params&rdquo; value passed in the JSON&rsquo;s <code>params</code> field.</p><p>First, store the <code>stdin</code> JSON in a file for convenience:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; out_request.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;source&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;host&#34;: &#34;consul&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;protocol&#34;: &#34;http&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;skip_ssl_check&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key&#34;: &#34;my-key&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;params&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;value&#34;: &#34;my-new-value-from-params&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Invoke the <code>out</code> using the <code>out_request.json</code> as <code>stdin</code> and update the <code>my-key</code> Consul key to be &ldquo;my-new-value-from-params&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat out_request.json | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  docker run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --volume <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/out-source <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --network<span style=color:#f92672>=</span>kv-resource_default <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --interactive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    clapclapexcitement/concourse-consul-kv-resource <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      /opt/resource/out /out-source<span style=color:#e6db74>&#34;
</span></span></span></code></pre></div><p>As a result, this prints JSON to <code>stdout</code> similar to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-new-value-from-params&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;metadata&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;timestamp&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;1572272431669&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-new-value-from-params&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And also note that the <code>my-key</code> in Consul is now &ldquo;my-new-value-from-params.&rdquo; We can verify this by <code>curl</code>-ing the Consul API, using <a href=https://stedolan.github.io/jq/>jq</a> to parse the JSON response, and using <code>base64</code> to decode the base64-encoded key&rsquo;s value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --silent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --request GET http://localhost:8500/v1/kv/my-key | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    jq -r <span style=color:#e6db74>&#39;.[0].Value&#39;</span> | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    base64 --decode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my-new-value-from-params
</span></span></code></pre></div><p>Alternatively, we could use <code>/opt/resource/out</code>&rsquo;s support of a <code>params.file</code> to update the <code>my-key</code>&rsquo;s value with a value read from a file.</p><p>First, create a <code>my-key</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; my-key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>my-new-value-from-file-params
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Next, update the <code>out_request.json</code> to use a <code>params.file</code> rather than a <code>params.value</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;params&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;file&#34;</span>: <span style=color:#e6db74>&#34;my-key&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>...</span>
</span></span></code></pre></div><p>This time, a re-invokation of the <code>docker run</code> outputs JSON like the following to <code>stdout</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-value-from-file-params&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;metadata&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;timestamp&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;1572273019536&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;my-value-from-file-params&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the <code>my-key</code> in Consul is now &ldquo;my-new-value-from-file-params:&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --silent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --request GET http://localhost:8500/v1/kv/my-key | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    jq -r <span style=color:#e6db74>&#39;.[0].Value&#39;</span> | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    base64 --decode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my-new-value-from-file-params
</span></span></code></pre></div><h2 id=automated-testing>Automated testing</h2><p>Testing practices and patterns vary throughout the ecosystem of Concourse resource types, in part because resource types can be authored in any programming or scripting language. Personally, I like to offer two levels of automated testing against a Concourse custom resource type:</p><ol><li>Unit tests that exercise the <code>check</code>, <code>in</code>, and <code>out</code> source code business logic. <code>concourse-consul-kv-resource</code>&rsquo;s source code is written in Node.js. In its case, a suite of <a href=https://mochajs.org/>Mocha</a> tests are run against mock Consul endpoints as part of its <code>docker build</code> process. These tests are most concerned with the Node.js source code.</li><li>Acceptance tests that exercise the end-to-end functionality against the end-result compiled resource type Docker image. <code>concourse-consul-kv-resource</code>&rsquo;s acceptance tests are authored in <a href=https://github.com/bats-core/bats-core>bats-core</a> and use a local <code>docker-compose</code>&rsquo;d Consul and <code>jq</code> to validate the behavior of the end-result <code>concourse-consul-kv-resource</code> Docker image. While the unit and acceptance tests overlap a bit in their responsibilities, the acceptance tests are most concerned that the compiled <code>concourse-consul-kv-resource</code> behaves as expected in an end-to-end fashion when interacting with a real Consul and real-world-like invocations.</li></ol><p>In addition to its automated tests, <code>concourse-consul-kv-resource</code> contains a <code>docker-compose.yml</code> that can be used by curious users to start a local Concourse, Consul, and Docker registry to test drive the resource type within a real Concourse pipeline. <a href=https://github.com/mdb/concourse-consul-kv-resource#functional-testing>Read more »</a></p><h2 id=further-reading-and-learning>Further reading and learning:</h2><ul><li><a href=https://github.com/mdb/concourse-consul-kv-resource>concourse-consul-kv-resource</a></li><li><a href=https://concourse-ci.org>Concourse docs</a></li><li><a href=https://concoursetutorial.com>Concourse tutorial</a></li></ul></div><ul class=tags><li><a href=/tags/concourse>concourse</a></li><li><a href=/tags/ci>ci</a></li><li><a href=/tags/cd>cd</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built backend services, automated cloud infrastructure management, designed CI/CD pipelines for high scale distributed systems, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.1499c53fed57df32a56089f3dde8b4b4d048c1ea53001475ffa6ec668ee36960.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
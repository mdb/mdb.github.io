document.addEventListener('DOMContentLoaded', () => {
  function fadeIn(image) {
    image.style.transition = 'opacity 2s';
    image.style.opacity = '1';
  }

  function fadeInImages() {
    const images = document.getElementsByTagName('img');

    for (let image of images) {
      // if image is already loaded, fade it in
      if (image.complete) {
        fadeIn(image);
      }

      image.addEventListener('load', () => {
        fadeIn(image);
      });
    }
  }

  function populateIgFeed(data) {
    const galleries = document.querySelectorAll('ul.ig-feed'),
      items = data.slice(0, 8).map(image => {
        return `
          <li class="item">
            <a class="thumbnail" href="${image.permalink}">
              <img src="${image.media_url}" />
            </a>
          </li>`;
      }).join('');

    galleries.forEach(gallery => gallery.innerHTML = items);
  }

  function fetchIgFeed() {
    // Published to GH pages via https://github.com/mdb/ig-feed/'s own
    // gh-pages branch, itself generated by ig-feed's GH Actions
    return fetch('https://mikeball.info/ig-feed/ig/media.json')
      .then(response => response.json())
      .then(populateIgFeed);
  }

  function populateShopFeed(data) {
    const galleries = document.querySelectorAll('ul.store-feed'),
      items = data.slice(0, 4).map(item => {
        const url = `https://tiendah.bigcartel.com/${item.url}`;

        return `
          <li class="item">
            <a class="thumbnail" href="${url}">
              <img src="${item.images[0].secure_url}" />
            </a>
            <div class="details">
              <aside>$${item.price}</aside>
              <h2><a href="${url}">${item.name}</a></h2>
              <p>${item.description}</p>
              <p><a href="${url}">Buy print</a></p>
            </div>
          </li>`;
      }).join('');

    galleries.forEach(gallery => gallery.innerHTML = items);
  }

  function fetchShopFeed() {
    return fetch('https://api.bigcartel.com/tiendah/products.json')
      .then(response => response.json())
      .then(populateShopFeed);
  }

  Promise.all([
    fetchIgFeed(),
    fetchShopFeed()
  ]).then(fadeInImages);

  const button = document.getElementsByTagName('button')[0],
    header = button.parentElement;

  button.addEventListener('click', () => {
    if (header.className === '') {
      header.className = 'toggled';

      return;
    }

    header.className = '';
  });
});

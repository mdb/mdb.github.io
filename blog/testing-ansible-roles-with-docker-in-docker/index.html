<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Testing Ansible Roles With Docker-in-Docker | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="How to develop and test Ansible roles with Molecule and Docker."><meta name=generator content="Hugo 0.111.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/main.min.0449f8f8ce19dc28665ca957772e02a195cf864c956f9534feb480742e9b486f.css></head><body class=blog-post><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=/instagram>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><article><header><h1>Testing Ansible Roles With Docker-in-Docker</h1><time>November 29, 2020</time></header><div><p><em>A brief guide and reference example explaining a technique for using Molecule and a Docker-in-Docker dev/test environment to test Ansible roles</em>.</p><h2 id=problem>Problem</h2><p><a href=https://www.ansible.com/>Ansible</a> encourages the use of <a href=https://github.com/ansible-community/molecule>Molecule</a> to test Ansible roles &ldquo;against multiple instances, operating systems and distributions, virtualization providers, test frameworks, and testing scenarios.&rdquo; <a href=https://molecule.readthedocs.io/en/latest/getting-started.html>Molecule documentation</a> offers an overview of how to get started, including how to use <a href=https://docker.io>Docker</a> as the test driver provider, as well as how to use Ansible as the <a href=https://molecule.readthedocs.io/en/latest/configuration.html#verifier>Molecule verifier</a>. But what if you&rsquo;d like to <em>also</em> use Docker as your development environment, thus avoiding the need to install any dependencies — Python, Ansible, Molecule, etc. — beyond Docker itself? Or what if the relevant CI/CD pipeline steps run in a container, as is the case with a <a href=https://concourse-ci.org/tasks.html>Concourse task</a>, for example?</p><h2 id=solution>Solution</h2><p><a href=https://www.docker.com/blog/docker-can-now-run-within-docker/>Docker-in-Docker</a> allows the use of a containerized dev/test environment, within which Molecule can leverage its Docker driver provider to test the Ansible role against sub-containers (Note, however: the solution isn&rsquo;t free of tradeoffs. Read on for further insight on security concerns).</p><h2 id=the-details>The Details</h2><p><a href=https://github.com/mdb/ansible-hello-world>mdb/ansible-hello-world</a> offers a basic reference example demonstrating the technique. For the sake of simplicity, the role&rsquo;s only responsibility is to create a <code>/hello-world.json</code> file on the targeted host. Its <code>molecule/converge.yml</code> file invokes the role against a Dockerized Ubuntu test container, while its <code>molecule/verify.yml</code> tests that the role behaves as expected and properly creates the <code>/hello-world.json</code> file on the targeted host. It requires no development dependencies beyond Docker (and <code>make</code>, arguably, though that&rsquo;s not a hard requirement).</p><p>To try it, clone the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/mdb/ansible-hello-world.git
</span></span><span style=display:flex><span>cd ansible-hello-world
</span></span></code></pre></div><p>&mldr;and run <code>make</code> to start a <a href=https://hub.docker.com/r/amidos/dcind/>amidos/dcind</a> container instance on which Docker is running, install Python, Ansible, and Molecule on it, and execute <code>molecule test</code> from within the container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>make
</span></span><span style=display:flex><span>docker run \
</span></span><span style=display:flex><span>  --volume /Users/mball0001/git/ansible-hello-world:/ansible-hello-world \
</span></span><span style=display:flex><span>  --workdir / \
</span></span><span style=display:flex><span>  --privileged \
</span></span><span style=display:flex><span>  --rm \
</span></span><span style=display:flex><span>  --tty \
</span></span><span style=display:flex><span>  clapclapexcitement/dind-ansible-molecule \
</span></span><span style=display:flex><span>  molecule test
</span></span><span style=display:flex><span>Starting Docker...
</span></span><span style=display:flex><span>waiting for docker to come up...
</span></span><span style=display:flex><span>/ansible-hello-world /
</span></span><span style=display:flex><span>fetch http://dl-cdn.alpinelinux.org/alpine/v3.10/main/x86_64/APKINDEX.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY [Converge] ****************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK [Gathering Facts] *********************************************************
</span></span><span style=display:flex><span>ok: [instance]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK [ansible-hello-world : create hello-world.json file] **********************
</span></span><span style=display:flex><span>changed: [instance]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>instance   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK [Assert that /hello-world.json has the expected contents] *****************
</span></span><span style=display:flex><span>ok: [instance] =&gt; {
</span></span><span style=display:flex><span>    &#34;changed&#34;: false,
</span></span><span style=display:flex><span>    &#34;msg&#34;: &#34;All assertions passed&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK [Delete docker network(s)] ************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>localhost    : ok=2    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INFO    Pruning extra files from scenario ephemeral directory
</span></span></code></pre></div><h2 id=improvements>Improvements</h2><p><del>In current implementation, Python, Ansible, and Molecule are installed on the <code>amidos/dcind</code>-based container on each invocation of <code>make</code>. While this exercises the role&rsquo;s <em>continuous integration</em> and compatibility with the latest versions of those dependencies, it&rsquo;s quite time consuming. To save time during test execution, these dependencies could be pre-installed on a purpose-built container image used instead of <code>amidos/dcind</code>. The <code>Dockerfile</code> for such a purpose-built image might look something like&mldr;</del></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> amidos/dcind</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  apk add python3 python3-dev py3-openssl py3-pip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUn</span> pip3 install --upgrade pip <span style=color:#f92672>&amp;&amp;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  pip3 install ansible molecule<span style=color:#f92672>[</span>docker<span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>Update</strong>: I&rsquo;ve published <a href=https://github.com/mdb/dind-ansible-molecule>mdb/dind-ansible-molecule</a>, which has the Python, Ansible, and Molecule dependencies baked in. This blog post and the <a href=https://github.com/mdb/ansible-hello-world>mdb/ansible-hello-world</a> reference example have been updated accordingly.</p><h2 id=a-development-environment>A Development Environment</h2><p>But what about those scenarios when you&rsquo;re rapidly iterating on the playbook? Or even the Molecule tests?</p><p><code>make shell</code> can be used to start up a <code>clapclapexcitement/dind-ansible-molecule</code> container and pop you into an interactive <code>bash</code> shell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ make shell
</span></span><span style=display:flex><span>docker run \
</span></span><span style=display:flex><span>  --volume /Users/mball0001/git/ansible-hello-world:/ansible-hello-world \
</span></span><span style=display:flex><span>  --workdir /ansible-hello-world \
</span></span><span style=display:flex><span>  --privileged \
</span></span><span style=display:flex><span>  --interactive \
</span></span><span style=display:flex><span>  --tty \
</span></span><span style=display:flex><span>  --rm \
</span></span><span style=display:flex><span>  clapclapexcitement/dind-ansible-molecule \
</span></span><span style=display:flex><span>    /bin/bash
</span></span><span style=display:flex><span>Starting Docker...
</span></span><span style=display:flex><span>waiting for docker to come up...
</span></span><span style=display:flex><span>bash-5.0#
</span></span></code></pre></div><p>From here, <code>molecule</code> commands like <code>molecule create</code>, <code>molecule converge</code>, and <code>molecule verify</code> can be invoked without having to fully tear down and rebuild the Docker-in-Docker container with each invocation; the testing container is left running between invocations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>bash-5.0# docker ps
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                                                        COMMAND                 CREATED             STATUS         PORTS  NAMES
</span></span><span style=display:flex><span>4ea283fec6fe  molecule_local/geerlingguy/docker-ubuntu1804-ansible:latest  &#34;/lib/systemd/systemd&#34;  About a minute ago  Up 36 seconds         instance
</span></span></code></pre></div><p>In addition to enabling faster, more frequent playbook edits and feedback from <code>molecule</code> commands, this is also helpful in those scenarios where you may want to shell into the test container to poke around and troubleshoot via <code>docker exec</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>docker exec -it &lt;CONTAINER_ID&gt; /bin/bash
</span></span></code></pre></div><h2 id=bonus-concourse-ci>Bonus: Concourse CI</h2><p>See <a href=https://github.com/mdb/ansible-hello-world/blob/main/ci/tasks/test.yml>ci/task.yml</a> for an example <a href=https://concourse-ci.org/tasks.html>Concourse task configuration</a> that invokes the playbook and Molecule tests against a test container within a Concourse task. The task uses the same <code>clapclapexcitement/dind-ansible-molecule</code> image used in development.</p><p>Its use within a Concourse pipeline <code>pipeline.yml</code> configuration file might look something like this, for example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>pull-request</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>check_every</span>: <span style=color:#ae81ff>24h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>webhook_token</span>: <span style=color:#ae81ff>((webhook-token))</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>mdb/ansible-hello-world</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_token</span>: <span style=color:#ae81ff>((access-token))</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>v3_endpoint</span>: <span style=color:#ae81ff>https://github.com/api/v3/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>v4_endpoint</span>: <span style=color:#ae81ff>https://github.com/api/graphql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>resource_types</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pull-request</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>registry-image</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>teliaoss/github-pr-resource</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>verify-pull-request</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plan</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>get</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>trigger</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>put</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>status</span>: <span style=color:#ae81ff>pending</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>file</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request/ci/tasks/test.yml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>on_success</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>put</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>status</span>: <span style=color:#ae81ff>success</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>on_failure</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>put</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>ansible-hello-world-pull-request</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>status</span>: <span style=color:#ae81ff>failure</span>
</span></span></code></pre></div><p>Note that the Concourse task must be executed with a <a href=https://concourse-ci.org/jobs.html#schema.step.task-step.privileged>privileged: true</a> configuration to utilize Docker-in-Docker capabilities. As a result, the container&rsquo;s <code>root</code> user is the system&rsquo;s actual <code>root</code> user. This comes with some tradeoffs and security risks, as noted in the <a href=https://concourse-ci.org/jobs.html#schema.step.task-step.privileged>Concourse documentation</a>, and should never be done with untrusted code. For this reason, the above-described technique may not be advisable for all use cases and circumstances.</p><p>I&rsquo;m curious to learn more about others&rsquo; techniques, especially Concourse-compatible techniques that avoid the use of container privilege escalation.</p></div><ul class=tags><li><a href=/tags/ansible>ansible</a></li><li><a href=/tags/ci/cd>CI/CD</a></li><li><a href=/tags/testing>testing</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end web applications, built
backend services, automated cloud infrastructure management, designed
CI/CD pipelines for high scale distributed systems, developed developer
platforms for large organizations, and contributed to numerous open
source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=https://clapclapexcitement.bsky.social>Bluesky</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.542672b67aa924d06e857fba942ea82bceb1ba468d461ef62da049fad70cd0a7.js></script>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-54324621-1","auto"),ga("send","pageview")</script></body></html>
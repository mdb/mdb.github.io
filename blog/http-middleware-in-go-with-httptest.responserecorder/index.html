<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>HTTP Middleware in Go with httptest.ResponseRecorder | Mike Ball</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/main.min.8045fe2b35396b813af7c5bdb7c91c9a6532c9642d70b49e21c4db98fc3558ac.css></head><body class=DEV><header><div class=mark><a href=/>Mike Ball</a></div><button>Toggle Navigation</button><div class=nav-wrap><nav class=primary><ul><li><a href=/blog>Blog</a></li><li><a href=#about>About</a></li></ul></nav><nav class=secondary><ul><li><a href=https://github.com/mdb>GitHub</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li></ul></nav><nav class=tertiary><ul><li><a href=https://tiendah.bigcartel.com>Shop</a></li><li><a href=#about>Contact</a></li></ul></nav></div></header><main role=main><div class=blog-post><aside class=divider><a href=/blog/>Blog</a></aside><time>February 13, 2021</time><article><header><h1>HTTP Middleware in Go with httptest.ResponseRecorder</h1></header><div><p><em>A technique for creating &ldquo;post-process&rdquo; HTTP middleware in Go.</em></p><h2 id=problem>Problem</h2><p>You need to add a bit of extra &ldquo;post-process&rdquo; functionality or logic beyond what an existing <a href=https://golang.org/pkg/net/http/#Handler>http.Handler</a> offers, but don&rsquo;t have the ability to modify the existing handler, perhaps because it&rsquo;s provided by a third party package. For example, how might you add an HTTP response header to the handler&rsquo;s HTTP response before the response is sent to the client?</p><p>While the <a href=https://medium.com/@matryer/the-http-handler-wrapper-technique-in-golang-updated-bc7fbcffa702>http.Handler wrapper technique</a> is commonly utilized to invoke code before and/or after invoking an <code>http.Handler</code>&rsquo;s <code>ServeHTTP</code>, method, it doesn&rsquo;t enable post-processing the <code>http.Handler</code>&rsquo;s handling of the <code>http.ResponseWriter</code>.</p><p>In other words, how could you write some <em>middleware</em> that wraps and adds to an <code>http.Handler</code>&rsquo;s existing functionality <em>after</em> the <code>http.Handler</code> has already processed a request and produced an HTTP response, thereby <em>modifying</em> the HTTP response before it&rsquo;s sent to the client?</p><h2 id=solution>Solution</h2><p>Use <a href=https://golang.org/pkg/net/http/httptest/#ResponseRecorder>httptest.ResponseRecorder</a> to record the <code>http.Handler</code>&rsquo;s response; this provides a hook through which the response can be modified as needed.</p><h2 id=a-basic-example>A basic example</h2><p>In the following example, <code>WrappedHandler</code> invokes the <code>http.Handler</code> it&rsquo;s passed, but uses an <a href=https://golang.org/pkg/net/http/httptest/#ResponseRecorder>httptest.ResponseRecorder</a> to record the <code>http.Handler</code>&rsquo;s response and add an <code>X-Foo</code> header before writing to the the <code>http.ResponseWriter</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// WrappedHandler uses the handler it&#39;s passed, but
</span></span></span><span style=display:flex><span><span style=color:#75715e>// adds an &#39;X-Foo: bar&#39; header to the response.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WrappedHandler</span>(<span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Use an httptest.ResponseRecorder to invoke handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// and record its response:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// https://golang.org/pkg/net/http/httptest/#ResponseRecorder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>rec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewRecorder</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Invoke handler with the http.ResponseRecorder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>rec</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Store the response in a &#39;res&#39; var
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rec</span>.<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Copy the recorded headers to the http.ResponseWriter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Header</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>k</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>CanonicalHeaderKey</span>(<span style=color:#a6e22e>k</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>()[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Set the custom &#39;X-Foo&#39; header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>()[<span style=color:#e6db74>&#34;X-Foo&#34;</span>] = <span style=color:#e6db74>&#34;bar&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Write the recorded status code to the http.ResponseWriter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Write the recorded body to the http.ResponseWriter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>rec</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Bytes</span>())
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=a-real-world-example>A real world example</h2><p><a href=https://github.com/concourse/concourse/pull/5897/files>Concourse pull request 5897</a> introduces what is perhaps a more realistic example via its <a href=https://github.com/concourse/concourse/pull/5897/files#diff-47f1a1fcbe74de4be3af39c657cec8111bcc235be0ca43b1c076f3a460585136R38>token.StoreAccessToken</a> function.</p><p><code>token.StoreAccessToken</code> provides middleware that records <code>/sky/issuer/token</code> requests&rsquo; response from a <a href=https://github.com/concourse/dex/>dex</a> <code>server.Server</code> and does some stuff with its HTTP response, including storing some of the response data in the Concourse database, as well as modifying the <code>access_token</code> field in its JSON response body.</p></div><ul class=tags><li><a href=/tags/http>http</a></li><li><a href=/tags/golang>golang</a></li></ul></article></div></main><footer><section><h1 id=about>Info</h1><div><h2>Mike Ball</h2><p>I live in Philadelphia and work as a multi-disciplinary software engineer & designer.</p><p>Over the years, I've developed front end UIs, server backends, automated cloud infrastructure provisioning, built continuous deployment pipelines for highly available applications, and contributed to numerous open source software projects.</p><p>I've also worked in graphic and UX design. Buy prints of my illustrations at <a href=https://tiendah.bigcartel.com>Tiendah</a>.</div><div class=double><h2>Shop Tiendah</h2><ul class="gallery store-feed"></ul><h2>Instagram</h2><ul class="gallery ig-feed"></ul></div><div><h2>Etc.</h2><ul><li><a href=http://github.com/mdb>GitHub</a></li><li><a href=http://twitter.com/clapexcitement>Twitter</a></li><li><a href=https://instagram.com/clapclapexcitement>Instagram</a></li><li><a href=/index.xml>RSS Feed</a></li><li><a href=https://tiendah.bigcartel.com>Shop Tiendah</a></li></ul><h2>Contact</h2><p>Interested in working with me? <a href=mailto:mikedball@gmail.com>Get in touch</a>.</p></div></section></footer><script type=text/javascript src=/js/main.min.da52d8ec13bd557c9a5cee7d197a95ba9bbe47f8ba6e93b2a4ac2ca9ac18b707.js></script></body></html>